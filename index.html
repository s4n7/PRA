<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Trimester Screening Calculator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c6fbb;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --light-bg: #f8f9fa;
        }
        
        .fts-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .section-card {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid var(--primary);
        }
        
        .result-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .chart-container {
            height: 300px;
            margin: 30px 0;
        }
        
        .risk-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin: 5px;
        }
        
        .low-risk { background: #d4edda; color: #155724; }
        .moderate-risk { background: #fff3cd; color: #856404; }
        .high-risk { background: #f8d7da; color: #721c24; }
        
        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            display: none;
            margin-top: 5px;
        }
        
        .required::after {
            content: " *";
            color: var(--danger);
        }
        
        .report-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .fts-container {
                padding: 15px;
            }
            .section-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="fts-container">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="text-primary">First Trimester Screening Calculator</h1>
            <p class="lead text-secondary">Comprehensive risk assessment with LMP integration</p>
        </div>
        
        <!-- Patient Information Section -->
        <div class="section-card">
            <h3><i class="bi bi-person-circle"></i> Patient Information</h3>
            <div class="row g-3 mt-3">
                <div class="col-md-6">
                    <label class="form-label required">Full Name</label>
                    <input type="text" class="form-control" id="patientName">
                    <div class="error-message" id="nameError">Name is required</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Patient ID</label>
                    <input type="text" class="form-control" id="patientID">
                </div>
                <div class="col-md-6">
                    <label class="form-label required">Date of Birth</label>
                    <input type="date" class="form-control" id="patientDOB" max="">
                    <div class="error-message" id="dobError">Valid date of birth is required</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Calculated Age</label>
                    <input type="text" class="form-control" id="calculatedAge" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Last Menstrual Period (LMP)</label>
                    <input type="date" class="form-control" id="lmp">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Ethnicity</label>
                    <select class="form-select" id="ethnicity">
                        <option value="asian">Asian</option>
                        <option value="caucasian">Caucasian</option>
                        <option value="african">African</option>
                        <option value="hispanic">Hispanic</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">Weight (kg)</label>
                    <input type="number" class="form-control" id="weight" min="40" max="200">
                    <div class="error-message" id="weightError">Valid weight (40-200 kg) required</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Smoking Status</label>
                    <select class="form-select" id="smokingStatus">
                        <option value="non-smoker">Non-smoker</option>
                        <option value="smoker">Smoker</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Test Information Section -->
        <div class="section-card">
            <h3><i class="bi bi-clipboard-data"></i> Test Parameters</h3>
            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label class="form-label required">Crown-Rump Length (CRL) in mm</label>
                    <input type="number" step="0.1" class="form-control" id="crl" min="41" max="76">
                    <div class="error-message" id="crlError">CRL must be 41-76mm</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label required">Nuchal Translucency (NT) in mm</label>
                    <input type="number" step="0.01" class="form-control" id="nt" min="0.5" max="8.0">
                    <div class="error-message" id="ntError">NT must be 0.5-8.0mm</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Diabetes Status</label>
                    <select class="form-select" id="diabetesStatus">
                        <option value="no">No</option>
                        <option value="type1">Type 1</option>
                        <option value="type2">Type 2</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">hCG Value (IU/ml)</label>
                    <input type="number" step="0.01" class="form-control" id="hcg" min="1">
                    <div class="error-message" id="hcgError">Valid hCG value required</div>
                </div>
                <div class="col-md-6">
                    <label class="form-label required">PAPP-A Value (ng/mL)</label>
                    <input type="number" step="0.01" class="form-control" id="pappa" min="1">
                    <div class="error-message" id="pappaError">Valid PAPP-A value required</div>
                </div>
                <div class="col-md-12">
                    <label class="form-label">Clinical Notes</label>
                    <textarea class="form-control" id="clinicalNotes" rows="2"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex justify-content-center gap-3 my-4">
            <button id="calculateBtn" class="btn btn-primary btn-lg px-5">
                Calculate Risk
            </button>
            <button id="resetBtn" class="btn btn-outline-secondary btn-lg px-5">
                Reset
            </button>
        </div>
        
        <!-- Loading Indicator -->
        <div class="text-center my-5" id="loadingSpinner" style="display: none;">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <h5 class="mt-3">Calculating Risks...</h5>
        </div>
        
        <!-- Error Alert -->
        <div class="alert alert-danger" id="errorAlert" style="display: none;">
            <strong>Calculation Error:</strong> <span id="errorMessage"></span>
        </div>
        
        <!-- Results Section -->
        <div class="result-card" id="resultSection" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="text-primary">Risk Assessment Results</h3>
                <button id="generateReportBtn" class="btn btn-success">
                    Generate Report
                </button>
            </div>
            
            <!-- Results Summary -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Key Results</h5>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <tr>
                                    <th>Gestational Age (CRL):</th>
                                    <td id="gaResult">-</td>
                                </tr>
                                <tr>
                                    <th>Gestational Age (LMP):</th>
                                    <td id="gaLmpResult">-</td>
                                </tr>
                                <tr>
                                    <th>hCG MoM:</th>
                                    <td id="hcgMomResult">-</td>
                                </tr>
                                <tr>
                                    <th>PAPP-A MoM:</th>
                                    <td id="pappaMomResult">-</td>
                                </tr>
                                <tr>
                                    <th>NT MoM:</th>
                                    <td id="ntMomResult">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Risk Assessment</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6>Trisomy 21 (Down Syndrome)</h6>
                                <div class="risk-indicator low-risk" id="t21Risk">1:2500</div>
                            </div>
                            <div class="mb-3">
                                <h6>Trisomy 18 (Edwards Syndrome)</h6>
                                <div class="risk-indicator low-risk" id="t18Risk">1:8500</div>
                            </div>
                            <div>
                                <h6>Trisomy 13 (Patau Syndrome)</h6>
                                <div class="risk-indicator low-risk" id="t13Risk">1:12500</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Biochemical Markers Visualization</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="markersChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Interpretation -->
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Interpretation & Recommendations</h5>
                </div>
                <div class="card-body">
                    <div id="interpretationText">
                        <p>The combined first trimester screening results indicate a <strong>low risk</strong> for major chromosomal abnormalities.</p>
                        <p>hCG and PAPP-A levels are within normal range for gestational age. Nuchal translucency measurement is normal.</p>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Recommendations:</h6>
                        <ul id="recommendationsList">
                            <li>Routine prenatal care with standard follow-up</li>
                            <li>Anatomy scan at 18-22 weeks gestation</li>
                            <li>Genetic counseling not indicated based on these results</li>
                        </ul>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Additional Comments:</label>
                        <textarea class="form-control" id="physicianComments" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Report Section -->
        <div class="report-section" id="reportSection">
            <div class="text-center mb-4">
                <h2 class="text-primary">FIRST TRIMESTER SCREENING REPORT</h2>
                <p class="text-secondary">Generated on: <span id="reportDate"></span></p>
                <hr>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <h4>Patient Information</h4>
                    <table class="table table-sm">
                        <tr><th>Name:</th><td id="reportPatientName"></td></tr>
                        <tr><th>ID:</th><td id="reportPatientID"></td></tr>
                        <tr><th>DOB:</th><td id="reportDOB"></td></tr>
                        <tr><th>Maternal Age:</th><td id="reportMaternalAge"></td></tr>
                        <tr><th>Ethnicity:</th><td id="reportEthnicity"></td></tr>
                        <tr><th>Weight:</th><td id="reportWeight"></td></tr>
                        <tr><th>LMP:</th><td id="reportLMP"></td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h4>Test Information</h4>
                    <table class="table table-sm">
                        <tr><th>Test Date:</th><td id="reportTestDate"></td></tr>
                        <tr><th>Gestational Age (CRL):</th><td id="reportGA"></td></tr>
                        <tr><th>Gestational Age (LMP):</th><td id="reportGALMP"></td></tr>
                        <tr><th>CRL:</th><td id="reportCRL"></td></tr>
                        <tr><th>NT:</th><td id="reportNT"></td></tr>
                    </table>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <h4>Results</h4>
                    <table class="table table-sm">
                        <tr><th>hCG Value:</th><td id="reportHCG"></td></tr>
                        <tr><th>hCG MoM:</th><td id="reportHCGMom"></td></tr>
                        <tr><th>PAPP-A Value:</th><td id="reportPAPP"></td></tr>
                        <tr><th>PAPP-A MoM:</th><td id="reportPAPPMom"></td></tr>
                        <tr><th>NT MoM:</th><td id="reportNTMom"></td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h4>Risk Assessment</h4>
                    <table class="table table-sm">
                        <tr><th>Trisomy 21:</th><td id="reportT21"></td></tr>
                        <tr><th>Trisomy 18:</th><td id="reportT18"></td></tr>
                        <tr><th>Trisomy 13:</th><td id="reportT13"></td></tr>
                    </table>
                </div>
            </div>
            
            <div class="mb-4">
                <h4>Graphical Summary</h4>
                <div style="height: 300px;">
                    <canvas id="reportChart"></canvas>
                </div>
            </div>
            
            <div class="mb-4">
                <h4>Interpretation & Recommendations</h4>
                <div id="reportInterpretation"></div>
                <div class="mt-3">
                    <h5>Physician Comments:</h5>
                    <div id="reportComments" style="min-height: 80px; border-top: 1px solid #dee2e6; padding-top: 10px;"></div>
                </div>
            </div>
            
            <div class="mt-5">
                <p class="text-center"><strong>Disclaimer:</strong> This screening test assesses the risk of certain chromosomal conditions but does not provide a definitive diagnosis. All results should be interpreted by a qualified healthcare professional.</p>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <p>Performing Physician: ________________________</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <p>Signature: ________________________</p>
                        <p>Date: ________________________</p>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button id="printReportBtn" class="btn btn-primary me-2">
                    Print Report
                </button>
                <button id="closeReportBtn" class="btn btn-outline-secondary ms-2">
                    Close Report
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize max date for DOB (18-45 years range)
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const maxDob = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
            const minDob = new Date(today.getFullYear() - 45, today.getMonth(), today.getDate());
            
            document.getElementById('patientDOB').max = maxDob.toISOString().split('T')[0];
            document.getElementById('patientDOB').min = minDob.toISOString().split('T')[0];
            document.getElementById('lmp').max = today.toISOString().split('T')[0];
            
            // Set LMP default to 10 weeks ago
            const defaultLmp = new Date();
            defaultLmp.setDate(today.getDate() - 70); // 70 days ≈ 10 weeks
            document.getElementById('lmp').value = defaultLmp.toISOString().split('T')[0];
            
            // Calculate age when DOB changes
            document.getElementById('patientDOB').addEventListener('change', calculateAgeFromDOB);
        });
        
        // Calculate maternal age from DOB
        function calculateAgeFromDOB() {
            const dobInput = document.getElementById('patientDOB');
            const ageField = document.getElementById('calculatedAge');
            
            if (!dobInput.value) {
                ageField.value = '';
                return;
            }
            
            const dob = new Date(dobInput.value);
            const today = new Date();
            
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            
            ageField.value = age + ' years';
        }
        
        // Calculate gestational age from LMP (for display only)
        function calculateGAFromLMP() {
            const lmpInput = document.getElementById('lmp');
            if (!lmpInput.value) return "Not provided";
            
            const lmp = new Date(lmpInput.value);
            const today = new Date();
            
            // Calculate difference in days
            const diffTime = Math.abs(today - lmp);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            const weeks = Math.floor(diffDays / 7);
            const days = diffDays % 7;
            
            return `${weeks} weeks ${days} days`;
        }
        
        // Validate form inputs
        function validateForm() {
            let isValid = true;
            const errors = [];
            
            // Reset errors
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('errorAlert').style.display = 'none';
            
            // Validate required fields
            const requiredFields = [
                {id: 'patientName', errorId: 'nameError', message: 'Name is required'},
                {id: 'patientDOB', errorId: 'dobError', message: 'Date of birth is required'},
                {id: 'weight', errorId: 'weightError', message: 'Weight is required (40-200 kg)'},
                {id: 'crl', errorId: 'crlError', message: 'CRL must be 41-76mm'},
                {id: 'nt', errorId: 'ntError', message: 'NT must be 0.5-8.0mm'},
                {id: 'hcg', errorId: 'hcgError', message: 'hCG value is required'},
                {id: 'pappa', errorId: 'pappaError', message: 'PAPP-A value is required'}
            ];
            
            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                const errorElement = document.getElementById(field.errorId);
                
                if (!element.value || 
                    (field.id === 'crl' && (element.value < 41 || element.value > 76)) ||
                    (field.id === 'nt' && (element.value < 0.5 || element.value > 8.0)) ||
                    (field.id === 'weight' && (element.value < 40 || element.value > 200))) {
                    
                    errorElement.textContent = field.message;
                    errorElement.style.display = 'block';
                    isValid = false;
                    errors.push(field.message);
                }
            });
            
            // Validate DOB
            const dob = document.getElementById('patientDOB').value;
            if (dob) {
                const dobDate = new Date(dob);
                const today = new Date();
                const minDob = new Date(today.getFullYear() - 45, today.getMonth(), today.getDate());
                const maxDob = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
                
                if (dobDate < minDob || dobDate > maxDob) {
                    document.getElementById('dobError').textContent = 'Age must be 18-45 years';
                    document.getElementById('dobError').style.display = 'block';
                    isValid = false;
                    errors.push('Invalid date of birth');
                }
            }
            
            // Validate LMP (only if provided)
            const lmp = document.getElementById('lmp').value;
            if (lmp) {
                const lmpDate = new Date(lmp);
                const today = new Date();
                
                if (lmpDate > today) {
                    document.getElementById('errorMessage').textContent = 'LMP cannot be in the future';
                    document.getElementById('errorAlert').style.display = 'block';
                    isValid = false;
                    errors.push('Invalid LMP date');
                }
            }
            
            if (!isValid) {
                document.getElementById('errorMessage').textContent = errors.join(', ');
                document.getElementById('errorAlert').style.display = 'block';
            }
            
            return isValid;
        }
        
        // Core calculation functions
        function calculateGestationalAge(crl) {
            if(crl < 41 || crl > 76) throw new Error("CRL must be between 41-76mm");
            return 50.678 + (0.649 * crl);
        }

        function calculateHcgMedian(gaWeeks) {
            return Math.pow(10, (-0.073895 * gaWeeks + 2.986791));
        }

        function calculatePappaMedian(gaWeeks) {
            return Math.pow(10, 
                (0.065670 * gaWeeks * gaWeeks) - 
                (1.433004 * gaWeeks) + 
                10.653544
            );
        }

        function calculateNtMedian(crl) {
            return (0.031 * crl) + 0.381;
        }
        
        function calculateRisks(momHcg, momPappa, momNt, maternalAge) {
            // Base risk based on maternal age
            const baseT21Risk = 1/(0.000627 + Math.exp(-16.2395 + 0.286 * (maternalAge - 0.5)));
            const baseT18Risk = 1/(0.000142 + Math.exp(-16.2395 + 0.286 * (maternalAge - 0.5)));
            const baseT13Risk = 1/(0.000071 + Math.exp(-16.2395 + 0.286 * (maternalAge - 0.5)));
            
            // Adjustment factors based on MoM values
            const t21Adjustment = Math.exp(
                -0.3596 * momNt + 
                0.2689 * Math.log(momHcg) + 
                -0.3722 * Math.log(momPappa)
            );
            
            const t18Adjustment = Math.exp(
                -0.556 * momNt + 
                -0.678 * Math.log(momHcg) + 
                -0.789 * Math.log(momPappa)
            );
            
            const t13Adjustment = Math.exp(
                -0.421 * momNt + 
                -0.532 * Math.log(momHcg) + 
                -0.643 * Math.log(momPappa)
            );
            
            // Calculate final risks
            const t21Risk = 1/(1 + ((1 - baseT21Risk)/baseT21Risk) / t21Adjustment);
            const t18Risk = 1/(1 + ((1 - baseT18Risk)/baseT18Risk) / t18Adjustment);
            const t13Risk = 1/(1 + ((1 - baseT13Risk)/baseT13Risk) / t13Adjustment);
            
            return {
                t21: formatRisk(1/t21Risk),
                t18: formatRisk(1/t18Risk),
                t13: formatRisk(1/t13Risk)
            };
        }
        
        function formatRisk(risk) {
            if (risk > 10000) return "1:" + Math.round(risk).toLocaleString();
            return "1:" + Math.round(risk);
        }
        
        function determineRiskLevel(riskStr) {
            const riskValue = parseInt(riskStr.split(":")[1].replace(/,/g, ''));
            if (riskValue < 150) return "high-risk";
            if (riskValue < 1000) return "moderate-risk";
            return "low-risk";
        }
        
        function createChart(ctx, momHcg, momPappa, momNt) {
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['hCG', 'PAPP-A', 'NT'],
                    datasets: [{
                        label: 'MoM Values',
                        data: [momHcg, momPappa, momNt],
                        backgroundColor: [
                            'rgba(44, 111, 187, 0.7)',
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ],
                        borderColor: [
                            'rgb(44, 111, 187)',
                            'rgb(40, 167, 69)',
                            'rgb(108, 117, 125)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            title: {
                                display: true,
                                text: 'Multiple of Median (MoM)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        annotation: {
                            annotations: {
                                normalRange: {
                                    type: 'line',
                                    yMin: 0.8,
                                    yMax: 0.8,
                                    borderColor: 'rgba(220, 53, 69, 0.7)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: 'Low Risk Threshold (0.8 MoM)',
                                        position: 'end'
                                    }
                                },
                                normalRange2: {
                                    type: 'line',
                                    yMin: 2.5,
                                    yMax: 2.5,
                                    borderColor: 'rgba(220, 53, 69, 0.7)',
                                    borderWidth: 2,
                                    borderDash: [6, 6],
                                    label: {
                                        display: true,
                                        content: 'High Risk Threshold (2.5 MoM)',
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function generateReport() {
            // Populate report data
            document.getElementById('reportPatientName').textContent = document.getElementById('patientName').value || 'Not provided';
            document.getElementById('reportPatientID').textContent = document.getElementById('patientID').value || 'N/A';
            document.getElementById('reportDOB').textContent = document.getElementById('patientDOB').value || 'N/A';
            document.getElementById('reportMaternalAge').textContent = document.getElementById('calculatedAge').value || 'N/A';
            document.getElementById('reportEthnicity').textContent = document.getElementById('ethnicity').options[document.getElementById('ethnicity').selectedIndex].text;
            document.getElementById('reportWeight').textContent = document.getElementById('weight').value ? document.getElementById('weight').value + ' kg' : 'N/A';
            document.getElementById('reportLMP').textContent = document.getElementById('lmp').value || 'Not provided';
            
            document.getElementById('reportGA').textContent = document.getElementById('gaResult').textContent;
            document.getElementById('reportGALMP').textContent = document.getElementById('gaLmpResult').textContent;
            document.getElementById('reportCRL').textContent = document.getElementById('crl').value + ' mm';
            document.getElementById('reportNT').textContent = document.getElementById('nt').value + ' mm';
            
            document.getElementById('reportHCG').textContent = document.getElementById('hcg').value + ' IU/ml';
            document.getElementById('reportHCGMom').textContent = document.getElementById('hcgMomResult').textContent;
            document.getElementById('reportPAPP').textContent = document.getElementById('pappa').value + ' ng/mL';
            document.getElementById('reportPAPPMom').textContent = document.getElementById('pappaMomResult').textContent;
            document.getElementById('reportNTMom').textContent = document.getElementById('ntMomResult').textContent;
            
            document.getElementById('reportT21').textContent = document.getElementById('t21Risk').textContent;
            document.getElementById('reportT18').textContent = document.getElementById('t18Risk').textContent;
            document.getElementById('reportT13').textContent = document.getElementById('t13Risk').textContent;
            
            const t21Class = document.getElementById('t21Risk').className;
            document.getElementById('reportT21').className = t21Class.includes('high') ? 'high-risk' : 
                t21Class.includes('moderate') ? 'moderate-risk' : 'low-risk';
                
            document.getElementById('reportInterpretation').innerHTML = document.getElementById('interpretationText').innerHTML;
            document.getElementById('reportComments').textContent = document.getElementById('physicianComments').value || 'No additional comments';
            
            // Set report date
            const now = new Date();
            document.getElementById('reportDate').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('reportTestDate').textContent = now.toLocaleDateString();
            
            // Create report chart
            const reportChartCtx = document.getElementById('reportChart').getContext('2d');
            const momHcg = parseFloat(document.getElementById('hcgMomResult').textContent);
            const momPappa = parseFloat(document.getElementById('pappaMomResult').textContent);
            const momNt = parseFloat(document.getElementById('ntMomResult').textContent);
            createChart(reportChartCtx, momHcg, momPappa, momNt);
            
            // Show report
            document.getElementById('reportSection').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            window.scrollTo(0, 0);
        }
        
        // Event Listeners
        document.getElementById('calculateBtn').addEventListener('click', function() {
            if (!validateForm()) return;
            
            try {
                // Show loading
                document.getElementById('loadingSpinner').style.display = 'block';
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('errorAlert').style.display = 'none';
                
                // Get values
                const crl = parseFloat(document.getElementById('crl').value);
                const nt = parseFloat(document.getElementById('nt').value);
                const hcg = parseFloat(document.getElementById('hcg').value);
                const pappa = parseFloat(document.getElementById('pappa').value);
                
                // Calculate maternal age
                calculateAgeFromDOB();
                const maternalAge = parseInt(document.getElementById('calculatedAge').value) || 30;
                
                // Calculate gestational age from CRL
                const gaDays = calculateGestationalAge(crl);
                const gaWeeks = gaDays / 7;
                
                // Get GA from LMP (display only)
                const lmpGA = calculateGAFromLMP();
                
                // Calculate medians
                const hcgMedian = calculateHcgMedian(gaWeeks);
                const pappaMedian = calculatePappaMedian(gaWeeks);
                const ntMedian = calculateNtMedian(crl);
                
                // Calculate MoMs
                const momHcg = hcg / hcgMedian;
                const momPappa = pappa / pappaMedian;
                const momNt = nt / ntMedian;
                
                // Format GA
                const weeks = Math.floor(gaDays / 7);
                const days = Math.round(gaDays % 7);
                
                // Display results
                document.getElementById('gaResult').textContent = `${weeks} weeks ${days} days`;
                document.getElementById('gaLmpResult').textContent = lmpGA;
                document.getElementById('hcgMomResult').textContent = momHcg.toFixed(2);
                document.getElementById('pappaMomResult').textContent = momPappa.toFixed(2);
                document.getElementById('ntMomResult').textContent = momNt.toFixed(2);
                
                // Calculate and display risks
                const risks = calculateRisks(momHcg, momPappa, momNt, maternalAge);
                document.getElementById('t21Risk').textContent = risks.t21;
                document.getElementById('t18Risk').textContent = risks.t18;
                document.getElementById('t13Risk').textContent = risks.t13;
                
                // Update risk indicators
                const t21RiskLevel = determineRiskLevel(risks.t21);
                document.getElementById('t21Risk').className = 'risk-indicator ' + t21RiskLevel;
                document.getElementById('t18Risk').className = 'risk-indicator ' + determineRiskLevel(risks.t18);
                document.getElementById('t13Risk').className = 'risk-indicator ' + determineRiskLevel(risks.t13);
                
                // Update interpretation
                const interpretation = document.getElementById('interpretationText');
                if (t21RiskLevel === 'high-risk') {
                    interpretation.innerHTML = `<p class="text-danger"><strong>HIGH RISK</strong> for Trisomy 21 detected.</p>
                    <p>hCG MoM is elevated at ${momHcg.toFixed(2)}, and PAPP-A MoM is reduced at ${momPappa.toFixed(2)}. NT measurement is ${momNt.toFixed(2)} MoM.</p>
                    <p>This combination suggests increased risk for Down syndrome.</p>`;
                    
                    const recList = document.getElementById('recommendationsList');
                    recList.innerHTML = `
                        <li>Genetic counseling recommended immediately</li>
                        <li>Diagnostic testing options: CVS or amniocentesis</li>
                        <li>Detailed anatomy ultrasound at 18-22 weeks</li>
                        <li>Consider cell-free DNA testing</li>
                    `;
                } else if (t21RiskLevel === 'moderate-risk') {
                    interpretation.innerHTML = `<p class="text-warning"><strong>MODERATE RISK</strong> for Trisomy 21 detected.</p>
                    <p>Biochemical markers show variations: hCG MoM ${momHcg.toFixed(2)}, PAPP-A MoM ${momPappa.toFixed(2)}, NT MoM ${momNt.toFixed(2)}.</p>
                    <p>Further assessment is recommended.</p>`;
                    
                    const recList = document.getElementById('recommendationsList');
                    recList.innerHTML = `
                        <li>Genetic counseling recommended</li>
                        <li>Consider cell-free DNA testing</li>
                        <li>Detailed anatomy ultrasound at 18-22 weeks</li>
                        <li>Follow-up hCG and PAPP-A testing if indicated</li>
                    `;
                } else {
                    interpretation.innerHTML = `<p class="text-success"><strong>LOW RISK</strong> for major chromosomal abnormalities.</p>
                    <p>hCG MoM: ${momHcg.toFixed(2)}, PAPP-A MoM: ${momPappa.toFixed(2)}, NT MoM: ${momNt.toFixed(2)} are within normal range for gestational age.</p>`;
                    
                    const recList = document.getElementById('recommendationsList');
                    recList.innerHTML = `
                        <li>Routine prenatal care with standard follow-up</li>
                        <li>Anatomy scan at 18-22 weeks gestation</li>
                        <li>Genetic counseling not indicated based on these results</li>
                    `;
                }
                
                // Show results
                setTimeout(function() {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('resultSection').style.display = 'block';
                    window.scrollTo(0, document.getElementById('resultSection').offsetTop);
                }, 1000);
                
            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('errorAlert').style.display = 'block';
            }
        });
        
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('patientName').value = '';
            document.getElementById('patientID').value = '';
            document.getElementById('patientDOB').value = '';
            document.getElementById('calculatedAge').value = '';
            document.getElementById('lmp').value = '';
            document.getElementById('ethnicity').value = 'asian';
            document.getElementById('weight').value = '';
            document.getElementById('smokingStatus').value = 'non-smoker';
            document.getElementById('crl').value = '';
            document.getElementById('nt').value = '';
            document.getElementById('diabetesStatus').value = 'no';
            document.getElementById('hcg').value = '';
            document.getElementById('pappa').value = '';
            document.getElementById('clinicalNotes').value = '';
            
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('reportSection').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
            
            // Reset LMP to default
            const today = new Date();
            const defaultLmp = new Date();
            defaultLmp.setDate(today.getDate() - 70);
            document.getElementById('lmp').value = defaultLmp.toISOString().split('T')[0];
        });
        
        document.getElementById('generateReportBtn').addEventListener('click', generateReport);
        
        document.getElementById('printReportBtn').addEventListener('click', function() {
            window.print();
        });
        
        document.getElementById('closeReportBtn').addEventListener('click', function() {
            document.getElementById('reportSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
        });
    </script>
</body>
</html>
