<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Trimester Screening</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #resultsSection, #resultsSection * {
                visibility: visible;
            }
            #resultsSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
            .report-container {
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .print-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                border-bottom: 2px solid #1e40af;
                padding-bottom: 5px;
            }
            .print-header img {
                height: 50px;
            }
            .compact-table {
                font-size: 12px;
                padding: 4px;
            }
            .compact-table th, .compact-table td {
                padding: 4px 8px;
            }
            .risk-card {
                padding: 8px;
                margin-bottom: 8px;
            }
        }
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2);
            border-left: 4px solid rgb(239, 68, 68);
        }
        .risk-moderate {
            background-color: rgba(234, 179, 8, 0.2);
            border-left: 4px solid rgb(234, 179, 8);
        }
        .risk-low {
            background-color: rgba(34, 197, 94, 0.2);
            border-left: 4px solid rgb(34, 197, 94);
        }
        .ga-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .disclaimer {
            background-color: #f3f4f6;
            border-top: 2px solid #e5e7eb;
            padding: 10px;
            font-size: 0.7rem;
            color: #6b7280;
            text-align: center;
            margin-top: 15px;
        }
        .developed-by {
            text-align: center;
            padding: 8px;
            font-size: 0.8rem;
            color: #4b5563;
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        .compact-results {
            max-height: 400px;
            overflow-y: auto;
        }
        .date-controls {
            display: flex;
            gap: 10px;
        }
        .date-controls > div {
            flex: 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-700 to-indigo-800 px-6 py-3">
                <h1 class="text-2xl font-bold text-white">First Trimester Screening</h1>
                <p class="text-blue-100 text-sm">Comprehensive risk assessment for chromosomal abnormalities</p>
            </div>
            
            <div class="p-6">
                <!-- Patient Information -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">
                        <i class="fas fa-user-circle mr-2 text-blue-600"></i>Patient Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Patient Name</label>
                            <input type="text" id="patientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Patient ID</label>
                            <input type="text" id="patientId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                            <input type="date" id="dob" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ethnicity</label>
                            <select id="ethnicity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="asian">Asian</option>
                                <option value="caucasian">Caucasian</option>
                                <option value="african">African</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Dates Section -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">
                        <i class="fas fa-calendar-alt mr-2 text-purple-600"></i>Dates
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sample Collection Date</label>
                            <input type="date" id="collectionDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ultrasound Date</label>
                            <input type="date" id="ultrasoundDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Report Date</label>
                            <input type="date" id="reportDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="<?php echo date('Y-m-d'); ?>">
                        </div>
                    </div>
                </div>
                
                <!-- Pregnancy Details -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">
                        <i class="fas fa-baby mr-2 text-pink-500"></i>Pregnancy Details
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">CRL (mm)</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="forceGA" class="mr-1">
                                    <label for="forceGA" class="text-xs text-gray-500">Force GA</label>
                                </div>
                            </div>
                            <input type="number" id="crl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Crown-rump length">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gestational Age (weeks+days)</label>
                            <div class="flex ga-controls">
                                <div class="flex w-full">
                                    <input type="number" id="weeks" min="10" max="13" class="w-1/2 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Weeks">
                                    <input type="number" id="days" min="0" max="6" class="w-1/2 px-3 py-2 border border-gray-300 rounded-r-md border-l-0 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Days">
                                </div>
                                <button id="calculateGA" class="ml-2 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    <i class="fas fa-calculator"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estimated GA from CRL</label>
                            <div class="px-3 py-2 bg-gray-100 rounded-md" id="calculatedGA">
                                Enter CRL to calculate
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Final Adjusted GA</label>
                            <div class="px-3 py-2 bg-blue-50 rounded-md font-medium" id="finalGA">
                                Not calculated
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Biochemical Markers -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">
                        <i class="fas fa-flask mr-2 text-green-600"></i>Biochemical Markers
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beta-hCG (IU/ml)</label>
                            <input type="number" step="0.01" id="betaHcg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PAPP-A (ng/mL)</label>
                            <input type="number" step="0.01" id="pappa" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Ultrasound Findings -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">
                        <i class="fas fa-procedures mr-2 text-purple-600"></i>Ultrasound Findings
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nuchal Translucency (mm)</label>
                            <input type="number" step="0.1" id="nt" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nasal Bone</label>
                            <select id="nasalBone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Factors -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">
                        <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>Risk Factors
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Previous Trisomy</label>
                            <select id="previousTrisomy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Calculated Maternal Age</label>
                            <div class="px-3 py-2 bg-gray-100 rounded-md" id="calculatedAge">
                                Enter DOB to calculate
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calculate Button -->
                <div class="flex justify-center mt-6">
                    <button id="calculateBtn" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-calculator mr-2"></i>Calculate Risk
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Section (Initially Hidden) -->
        <div id="resultsSection" class="hidden bg-white rounded-lg shadow-lg overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-green-600 to-teal-700 px-6 py-3">
                <h2 class="text-2xl font-bold text-white">Screening Results</h2>
                <p class="text-green-100 text-sm">First Trimester Combined Screening Report</p>
            </div>
            
            <div class="p-6 compact-results">
                <!-- Patient Summary -->
                <div class="mb-4">
                    <div class="print-header">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Fetal Health Screening Report</h3>
                            <p class="text-xs text-gray-600">Comprehensive First Trimester Assessment</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-600">Report Date: <span id="resultReportDate"></span></p>
                            <p class="text-xs text-gray-600">Patient ID: <span id="resultId"></span></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <table class="w-full border border-gray-200 compact-table">
                            <tr>
                                <th class="bg-gray-100 text-left">Patient Name</th>
                                <td id="resultName"></td>
                            </tr>
                            <tr>
                                <th class="bg-gray-100 text-left">Date of Birth</th>
                                <td id="resultDob"></td>
                            </tr>
                            <tr>
                                <th class="bg-gray-100 text-left">Maternal Age</th>
                                <td id="resultMaternalAge"></td>
                            </tr>
                        </table>
                        
                        <table class="w-full border border-gray-200 compact-table">
                            <tr>
                                <th class="bg-gray-100 text-left">Sample Collection</th>
                                <td id="resultCollectionDate"></td>
                            </tr>
                            <tr>
                                <th class="bg-gray-100 text-left">Ultrasound Date</th>
                                <td id="resultUltrasoundDate"></td>
                            </tr>
                            <tr>
                                <th class="bg-gray-100 text-left">Gestational Age</th>
                                <td id="resultGestationalAge"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Risk Assessment -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Risk Assessment</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div id="t21Risk" class="risk-card">
                            <p class="text-sm font-medium mb-1">Trisomy 21 (Down)</p>
                            <p class="text-xl font-bold" id="t21RiskValue">1:0</p>
                            <p class="text-xs" id="t21RiskCategory"></p>
                        </div>
                        <div id="t18Risk" class="risk-card">
                            <p class="text-sm font-medium mb-1">Trisomy 18 (Edwards)</p>
                            <p class="text-xl font-bold" id="t18RiskValue">1:0</p>
                            <p class="text-xs" id="t18RiskCategory"></p>
                        </div>
                        <div id="t13Risk" class="risk-card">
                            <p class="text-sm font-medium mb-1">Trisomy 13 (Patau)</p>
                            <p class="text-xl font-bold" id="t13RiskValue">1:0</p>
                            <p class="text-xs" id="t13RiskCategory"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Results -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Detailed Results</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border border-gray-200 compact-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left">Parameter</th>
                                    <th class="text-left">Value</th>
                                    <th class="text-left">Median</th>
                                    <th class="text-left">MoM</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr>
                                    <td>Beta-hCG</td>
                                    <td id="hcgValue"></td>
                                    <td id="hcgMedian"></td>
                                    <td id="hcgMom"></td>
                                </tr>
                                <tr>
                                    <td>PAPP-A</td>
                                    <td id="pappaValue"></td>
                                    <td id="pappaMedian"></td>
                                    <td id="pappaMom"></td>
                                </tr>
                                <tr>
                                    <td>Nuchal Translucency</td>
                                    <td id="ntValue"></td>
                                    <td>-</td>
                                    <td id="ntMom"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Interpretation & Recommendations -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Interpretation</h3>
                        <div class="bg-gray-50 p-3 rounded-md text-xs">
                            <p id="interpretationText"></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Recommendations</h3>
                        <div class="bg-gray-50 p-3 rounded-md text-xs">
                            <ul class="list-disc pl-5" id="recommendationsList">
                                <!-- Will be filled by JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Report Actions -->
                <div class="flex flex-wrap justify-between mt-6 no-print">
                    <button id="printBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-print mr-2"></i>Print Report
                    </button>
                    <button id="pdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-file-pdf mr-2"></i>Download PDF
                    </button>
                    <button id="newPatientBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-user-plus mr-2"></i>New Patient
                    </button>
                </div>
                
                <!-- Disclaimer -->
                <div class="disclaimer no-print">
                    <p class="font-medium">Disclaimer:</p>
                    <p>This screening test provides a risk assessment and is not diagnostic. A high-risk result does not confirm the presence of an abnormality, and a low-risk result does not guarantee a normal outcome. All results should be interpreted in conjunction with clinical evaluation and other diagnostic tests if indicated. Consult a genetic counselor or specialist for further information.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="developed-by">
        <p>Developed by Clinicalsci | Medical Screening Solutions</p>
    </div>

    <script>
        // DOM Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsSection = document.getElementById('resultsSection');
        const printBtn = document.getElementById('printBtn');
        const pdfBtn = document.getElementById('pdfBtn');
        const newPatientBtn = document.getElementById('newPatientBtn');
        const calculateGA = document.getElementById('calculateGA');
        const forceGA = document.getElementById('forceGA');
        const calculatedGA = document.getElementById('calculatedGA');
        const finalGA = document.getElementById('finalGA');
        const dobInput = document.getElementById('dob');
        const calculatedAge = document.getElementById('calculatedAge');
        const collectionDateInput = document.getElementById('collectionDate');
        const ultrasoundDateInput = document.getElementById('ultrasoundDate');
        const reportDateInput = document.getElementById('reportDate');

        // Event Listeners
        calculateBtn.addEventListener('click', calculateRisk);
        printBtn.addEventListener('click', printReport);
        pdfBtn.addEventListener('click', generatePDF);
        newPatientBtn.addEventListener('click', resetForm);
        calculateGA.addEventListener('click', calculateGAFromCRL);
        
        // Date calculations
        dobInput.addEventListener('change', calculateAgeFromDOB);
        collectionDateInput.addEventListener('change', calculateFinalGA);
        ultrasoundDateInput.addEventListener('change', calculateFinalGA);
        
        // Calculate gestational age from CRL using Robinson method
        function calculateGAFromCRL() {
            const crl = parseFloat(document.getElementById('crl').value);
            if (!isNaN(crl)) {
                // Robinson formula: GA (days) = 8.052 * √(CRL) + 23.73
                const gaDays = 8.052 * Math.sqrt(crl) + 23.73;
                const weeks = Math.floor(gaDays / 7);
                const days = Math.round(gaDays % 7);
                
                if (weeks >= 10 && weeks <= 13) {
                    document.getElementById('weeks').value = weeks;
                    document.getElementById('days').value = days;
                    calculatedGA.textContent = `${weeks} weeks + ${days} days`;
                    calculateFinalGA();
                } else {
                    calculatedGA.textContent = "CRL out of range (10-13 weeks)";
                }
            } else {
                calculatedGA.textContent = "Enter valid CRL";
            }
        }
        
        // Calculate patient age from DOB including days
        function calculateAgeFromDOB() {
            const dob = new Date(dobInput.value);
            if (!isNaN(dob.getTime())) {
                const today = new Date();
                let years = today.getFullYear() - dob.getFullYear();
                let months = today.getMonth() - dob.getMonth();
                let days = today.getDate() - dob.getDate();
                
                if (days < 0) {
                    months--;
                    days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                }
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                const ageInDays = Math.floor((today - dob) / (1000 * 60 * 60 * 24));
                calculatedAge.textContent = `${years} years, ${months} months (${ageInDays} days)`;
            } else {
                calculatedAge.textContent = "Enter valid DOB";
            }
        }
        
        // Calculate final GA adjusted for ultrasound and collection dates
        function calculateFinalGA() {
            const weeks = parseInt(document.getElementById('weeks').value);
            const days = parseInt(document.getElementById('days').value);
            const ultrasoundDate = new Date(ultrasoundDateInput.value);
            const collectionDate = new Date(collectionDateInput.value);
            
            if (isNaN(weeks) || isNaN(days) || isNaN(ultrasoundDate.getTime()) || isNaN(collectionDate.getTime())) {
                finalGA.textContent = "Complete all fields";
                return;
            }
            
            // Calculate GA at ultrasound in days
            const gaAtUltrasound = (weeks * 7) + days;
            
            // Calculate days difference between ultrasound and collection
            const timeDiff = collectionDate - ultrasoundDate;
            const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            // Adjust GA
            const finalGADays = gaAtUltrasound + dayDiff;
            const finalWeeks = Math.floor(finalGADays / 7);
            const finalDays = finalGADays % 7;
            
            finalGA.textContent = `${finalWeeks} weeks + ${finalDays} days`;
        }
        
        // Main calculation function
        function calculateRisk() {
            // Get input values
            const patientName = document.getElementById('patientName').value;
            const patientId = document.getElementById('patientId').value;
            const dob = document.getElementById('dob').value;
            const ethnicity = document.getElementById('ethnicity').value;
            const weeks = parseInt(document.getElementById('weeks').value);
            const days = parseInt(document.getElementById('days').value);
            const crl = parseFloat(document.getElementById('crl').value);
            const betaHcg = parseFloat(document.getElementById('betaHcg').value);
            const pappa = parseFloat(document.getElementById('pappa').value);
            const nt = parseFloat(document.getElementById('nt').value);
            const nasalBone = document.getElementById('nasalBone').value;
            const previousTrisomy = document.getElementById('previousTrisomy').value;
            const collectionDate = document.getElementById('collectionDate').value;
            const ultrasoundDate = document.getElementById('ultrasoundDate').value;
            const reportDate = document.getElementById('reportDate').value;
            
            // Validate inputs
            if (!patientName || !weeks || !days || isNaN(betaHcg) || isNaN(pappa) || isNaN(nt) || !dob) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (weeks < 10 || weeks > 13) {
                alert('Gestational age must be between 10+0 and 13+6 weeks');
                return;
            }
            
            if (days < 0 || days > 6) {
                alert('Days must be between 0 and 6');
                return;
            }
            
            // Calculate maternal age
            const today = new Date();
            const birthDate = new Date(dob);
            let maternalAge = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                maternalAge--;
            }
            
            // Calculate risks
            const riskT21 = calculateRiskT21(maternalAge, previousTrisomy === 'yes', betaHcg, pappa, nt, nasalBone);
            const riskT18 = calculateRiskT18(maternalAge, previousTrisomy === 'yes', betaHcg, pappa, nt);
            const riskT13 = calculateRiskT13(maternalAge, previousTrisomy === 'yes', betaHcg, pappa, nt);
            
            // Display results
            displayResults(
                patientName, patientId, dob, ethnicity, maternalAge,
                weeks, days, crl, betaHcg, pappa, nt, nasalBone,
                riskT21, riskT18, riskT13,
                collectionDate, ultrasoundDate, reportDate
            );
            
            // Show results section
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Risk calculation functions
        function calculateRiskT21(age, prevTrisomy, hcg, pappa, nt, nasalBone) {
            // Base risk based on maternal age
            let baseRisk;
            if (age < 25) baseRisk = 1/1350;
            else if (age < 30) baseRisk = 1/900;
            else if (age < 35) baseRisk = 1/350;
            else if (age < 40) baseRisk = 1/100;
            else baseRisk = 1/25;
            
            // Adjust for previous trisomy
            if (prevTrisomy) baseRisk *= 1.5;
            
            // Adjust for biomarkers
            if (hcg > 2.5) baseRisk *= 1.8;
            if (pappa < 0.5) baseRisk *= 2.2;
            
            // Adjust for NT
            if (nt > 3.0) baseRisk *= 3.5;
            else if (nt > 2.5) baseRisk *= 1.8;
            
            // Adjust for nasal bone
            if (nasalBone === 'absent') baseRisk *= 5;
            
            return baseRisk;
        }
        
        function calculateRiskT18(age, prevTrisomy, hcg, pappa, nt) {
            // Base risk based on maternal age
            let baseRisk;
            if (age < 25) baseRisk = 1/5000;
            else if (age < 30) baseRisk = 1/4000;
            else if (age < 35) baseRisk = 1/2500;
            else if (age < 40) baseRisk = 1/1000;
            else baseRisk = 1/500;
            
            // Adjust for previous trisomy
            if (prevTrisomy) baseRisk *= 1.5;
            
            // Adjust for biomarkers
            if (hcg < 0.3) baseRisk *= 3;
            if (pappa < 0.3) baseRisk *= 4;
            
            // Adjust for NT
            if (nt > 3.0) baseRisk *= 4;
            
            return baseRisk;
        }
        
        function calculateRiskT13(age, prevTrisomy, hcg, pappa, nt) {
            // Base risk based on maternal age
            let baseRisk;
            if (age < 25) baseRisk = 1/16000;
            else if (age < 30) baseRisk = 1/12000;
            else if (age < 35) baseRisk = 1/7000;
            else if (age < 40) baseRisk = 1/2500;
            else baseRisk = 1/1000;
            
            // Adjust for previous trisomy
            if (prevTrisomy) baseRisk *= 1.5;
            
            // Adjust for biomarkers
            if (hcg < 0.4) baseRisk *= 2.5;
            if (pappa < 0.4) baseRisk *= 3;
            
            // Adjust for NT
            if (nt > 3.0) baseRisk *= 3.5;
            
            return baseRisk;
        }
        
        // Display results function
        function displayResults(
            patientName, patientId, dob, ethnicity, maternalAge,
            weeks, days, crl, betaHcg, pappa, nt, nasalBone,
            riskT21, riskT18, riskT13,
            collectionDate, ultrasoundDate, reportDate
        ) {
            // Format patient info
            document.getElementById('resultName').textContent = patientName;
            document.getElementById('resultId').textContent = patientId || 'N/A';
            document.getElementById('resultDob').textContent = dob ? new Date(dob).toLocaleDateString() : 'N/A';
            document.getElementById('resultMaternalAge').textContent = `${maternalAge} years`;
            document.getElementById('resultCollectionDate').textContent = collectionDate ? new Date(collectionDate).toLocaleDateString() : 'N/A';
            document.getElementById('resultUltrasoundDate').textContent = ultrasoundDate ? new Date(ultrasoundDate).toLocaleDateString() : 'N/A';
            document.getElementById('resultGestationalAge').textContent = `${weeks}+${days} weeks`;
            document.getElementById('resultReportDate').textContent = reportDate ? new Date(reportDate).toLocaleDateString() : 'N/A';
            
            // Format risks
            const formattedRiskT21 = formatRisk(riskT21);
            const formattedRiskT18 = formatRisk(riskT18);
            const formattedRiskT13 = formatRisk(riskT13);
            
            document.getElementById('t21RiskValue').textContent = formattedRiskT21;
            document.getElementById('t18RiskValue').textContent = formattedRiskT18;
            document.getElementById('t13RiskValue').textContent = formattedRiskT13;
            
            // Set risk categories and styling
            setRiskCategory('t21Risk', riskT21);
            setRiskCategory('t18Risk', riskT18);
            setRiskCategory('t13Risk', riskT13);
            
            // Fill detailed results
            document.getElementById('hcgValue').textContent = betaHcg.toFixed(2);
            document.getElementById('hcgMedian').textContent = "N/A";
            document.getElementById('hcgMom').textContent = "N/A";
            
            document.getElementById('pappaValue').textContent = pappa.toFixed(2);
            document.getElementById('pappaMedian').textContent = "N/A";
            document.getElementById('pappaMom').textContent = "N/A";
            
            document.getElementById('ntValue').textContent = nt.toFixed(1);
            document.getElementById('ntMom').textContent = "N/A";
            
            // Set interpretation and recommendations
            setInterpretationAndRecommendations(riskT21, riskT18, riskT13, nt, nasalBone);
        }
        
        function formatRisk(risk) {
            if (risk >= 1) return "1:1";
            if (risk <= 0) return "1:∞";
            
            const inverse = Math.round(1 / risk);
            return `1:${inverse}`;
        }
        
        function setRiskCategory(elementId, risk) {
            const inverseRisk = 1 / risk;
            const element = document.getElementById(elementId);
            const categoryElement = document.getElementById(`${elementId}Category`);
            
            if (inverseRisk <= 50) {
                // High risk
                element.className = "risk-card risk-high";
                categoryElement.textContent = "High Risk";
                categoryElement.className = "text-xs text-red-600 font-medium";
            } else if (inverseRisk <= 1000) {
                // Moderate risk
                element.className = "risk-card risk-moderate";
                categoryElement.textContent = "Moderate Risk";
                categoryElement.className = "text-xs text-yellow-600 font-medium";
            } else {
                // Low risk
                element.className = "risk-card risk-low";
                categoryElement.textContent = "Low Risk";
                categoryElement.className = "text-xs text-green-600 font-medium";
            }
        }
        
        function setInterpretationAndRecommendations(riskT21, riskT18, riskT13, nt, nasalBone) {
            const interpretationText = document.getElementById('interpretationText');
            const recommendationsList = document.getElementById('recommendationsList');
            
            // Clear previous recommendations
            recommendationsList.innerHTML = '';
            
            // Base interpretation
            let interpretation = "The risk assessment is based on maternal age, fetal nuchal translucency measurement, and maternal serum biochemistry (free β-hCG and PAPP-A). This screening test has a detection rate of approximately 90% for trisomy 21 with a 5% false-positive rate.";
            
            // Add specific findings
            if (nt > 3.5) {
                interpretation += " The nuchal translucency measurement is significantly increased, which may indicate an increased risk for chromosomal abnormalities or congenital heart defects.";
            } else if (nt > 2.5) {
                interpretation += " The nuchal translucency measurement is mildly increased.";
            }
            
            if (nasalBone === 'absent') {
                interpretation += " The fetal nasal bone appears absent, which is a soft marker for trisomy 21.";
            }
            
            interpretationText.textContent = interpretation;
            
            // Add standard recommendations
            addRecommendation(recommendationsList, "Detailed counseling regarding the screening results should be provided.");
            
            // Risk-specific recommendations
            const inverseRiskT21 = 1 / riskT21;
            
            if (inverseRiskT21 <= 50) {
                addRecommendation(recommendationsList, "Invasive diagnostic testing (CVS or amniocentesis) should be offered due to high risk for trisomy 21.");
                addRecommendation(recommendationsList, "Consider fetal echocardiography due to increased NT measurement.");
            } else if (inverseRiskT21 <= 1000) {
                addRecommendation(recommendationsList, "Non-invasive prenatal testing (NIPT) should be considered as a follow-up test.");
                addRecommendation(recommendationsList, "Detailed ultrasound at 18-20 weeks is recommended.");
            } else {
                addRecommendation(recommendationsList, "Routine prenatal care is recommended with standard ultrasound at 18-20 weeks.");
            }
            
            if (nt > 3.5) {
                addRecommendation(recommendationsList, "Fetal echocardiography is strongly recommended due to significantly increased NT measurement.");
            } else if (nt > 2.5) {
                addRecommendation(recommendationsList, "Consider fetal echocardiography due to mildly increased NT measurement.");
            }
            
            if (nasalBone === 'absent') {
                addRecommendation(recommendationsList, "Follow-up ultrasound to reassess nasal bone is recommended.");
            }
        }
        
        function addRecommendation(listElement, text) {
            const li = document.createElement('li');
            li.textContent = text;
            listElement.appendChild(li);
        }
        
        // Print and PDF functions
        function printReport() {
            // Hide everything except results before printing
            document.body.classList.add('printing');
            window.print();
            document.body.classList.remove('printing');
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // Use html2canvas to capture the results section
            html2canvas(document.getElementById('resultsSection'), {
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth() - 40;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
                
                // Add disclaimer
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Disclaimer: This screening test provides a risk assessment and is not diagnostic. Consult a genetic counselor or specialist for further information.', 
                    40, doc.internal.pageSize.getHeight() - 30, {maxWidth: 500});
                
                // Add footer
                doc.text('Developed by Clinicalsci | Medical Screening Solutions', 
                    doc.internal.pageSize.getWidth()/2, doc.internal.pageSize.getHeight() - 10, 
                    {align: 'center'});
                
                // Save the PDF
                doc.save('First_Trimester_Screening_Report.pdf');
            });
        }
        
        function resetForm() {
            // Clear all form fields
            document.getElementById('patientName').value = '';
            document.getElementById('patientId').value = '';
            document.getElementById('dob').value = '';
            document.getElementById('ethnicity').selectedIndex = 0;
            document.getElementById('crl').value = '';
            document.getElementById('weeks').value = '';
            document.getElementById('days').value = '';
            document.getElementById('betaHcg').value = '';
            document.getElementById('pappa').value = '';
            document.getElementById('nt').value = '';
            document.getElementById('nasalBone').selectedIndex = 0;
            document.getElementById('previousTrisomy').selectedIndex = 0;
            document.getElementById('collectionDate').value = '';
            document.getElementById('ultrasoundDate').value = '';
            document.getElementById('calculatedGA').textContent = 'Enter CRL to calculate';
            document.getElementById('finalGA').textContent = 'Not calculated';
            document.getElementById('calculatedAge').textContent = 'Enter DOB to calculate';
            document.getElementById('forceGA').checked = false;
            
            // Hide results section
            resultsSection.classList.add('hidden');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        // Initialize with current date
        document.getElementById('reportDate').valueAsDate = new Date();
    </script>
</body>
</html>
