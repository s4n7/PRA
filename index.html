<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Trimester Screening</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .risk-high {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 4px solid rgb(239, 68, 68);
        }
        .risk-moderate {
            background-color: rgba(234, 179, 8, 0.1);
            border-left: 4px solid rgb(234, 179, 8);
        }
        .risk-low {
            background-color: rgba(34, 197, 94, 0.1);
            border-left: 4px solid rgb(34, 197, 94);
        }
        .input-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c5282;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        .report-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 30px;
        }
        .report-header {
            border-bottom: 2px solid #1e40af;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }
        .report-table th, .report-table td {
            border: 1px solid #e2e8f0;
            padding: 10px 15px;
            text-align: left;
        }
        .report-table th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        .report-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .risk-card {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .chart-container {
            height: 250px;
            margin: 25px 0;
        }
        .disclaimer {
            background-color: #f3f4f6;
            border-top: 2px solid #e5e7eb;
            padding: 15px;
            font-size: 0.8rem;
            color: #6b7280;
            text-align: center;
            margin-top: 20px;
        }
        .developed-by {
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
            color: #4b5563;
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        .maternal-risk-table th {
            background-color: #dbeafe;
        }
        .combined-risk-table th {
            background-color: #ede9fe;
        }
        .risk-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .risk-badge-high {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .risk-badge-moderate {
            background-color: #fef3c7;
            color: #b45309;
        }
        .risk-badge-low {
            background-color: #dcfce7;
            color: #15803d;
        }
        .crl-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .risk-section {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        .risk-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Input Form Section -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-blue-700 to-indigo-800 px-6 py-4">
                <h1 class="text-2xl font-bold text-white"><i class="fas fa-baby mr-2"></i>First Trimester Screening</h1>
                <p class="text-blue-100 text-sm">Comprehensive risk assessment for chromosomal abnormalities</p>
            </div>
            
            <div class="p-6">
                <!-- Patient Information -->
                <div class="input-card">
                    <h2 class="section-title">
                        <i class="fas fa-user-circle"></i>
                        <span>Patient Information</span>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Patient Name</label>
                            <input type="text" id="patientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Patient ID</label>
                            <input type="text" id="patientId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                            <input type="date" id="dob" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ethnicity</label>
                            <select id="ethnicity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="asian">Asian</option>
                                <option value="caucasian">Caucasian</option>
                                <option value="african">African</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Dates Section -->
                <div class="input-card">
                    <h2 class="section-title">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Dates</span>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sample Collection Date</label>
                            <input type="date" id="collectionDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ultrasound Date</label>
                            <input type="date" id="ultrasoundDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Report Date</label>
                            <input type="date" id="reportDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Pregnancy Details -->
                <div class="input-card">
                    <h2 class="section-title">
                        <i class="fas fa-baby"></i>
                        <span>Pregnancy Details</span>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">CRL (mm)</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="forceGA" class="mr-1">
                                    <label for="forceGA" class="text-xs text-gray-500">Force GA</label>
                                </div>
                            </div>
                            <div class="crl-input-container">
                                <input type="number" id="crl" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Crown-rump length">
                                <button id="calculateGA" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap">
                                    <i class="fas fa-calculator mr-1"></i>Calculate GA
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gestational Age (weeks+days)</label>
                            <div class="flex">
                                <div class="flex w-full">
                                    <input type="number" id="weeks" min="10" max="13" class="w-1/2 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Weeks">
                                    <input type="number" id="days" min="0" max="6" class="w-1/2 px-3 py-2 border border-gray-300 rounded-r-md border-l-0 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Days">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estimated GA from CRL</label>
                            <div class="px-3 py-2 bg-gray-100 rounded-md" id="calculatedGA">
                                Enter CRL to calculate
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Final Adjusted GA</label>
                            <div class="px-3 py-2 bg-blue-50 rounded-md font-medium" id="finalGA">
                                Not calculated
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Biochemical Markers -->
                <div class="input-card">
                    <h2 class="section-title">
                        <i class="fas fa-flask"></i>
                        <span>Biochemical Markers</span>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beta-hCG (IU/ml)</label>
                            <input type="number" step="0.01" id="betaHcg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PAPP-A (ng/mL)</label>
                            <input type="number" step="0.01" id="pappa" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Ultrasound Findings -->
                <div class="input-card">
                    <h2 class="section-title">
                        <i class="fas fa-procedures"></i>
                        <span>Ultrasound Findings</span>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nuchal Translucency (mm)</label>
                            <input type="number" step="0.1" id="nt" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nasal Bone</label>
                            <select id="nasalBone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Factors -->
                <div class="input-card">
                    <h2 class="section-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Risk Factors</span>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Previous Trisomy</label>
                            <select id="previousTrisomy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Calculated Maternal Age</label>
                            <div class="px-3 py-2 bg-gray-100 rounded-md" id="calculatedAge">
                                Enter DOB to calculate
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calculate Button -->
                <div class="flex justify-center mt-6">
                    <button id="calculateBtn" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-calculator mr-2"></i>Calculate Risk
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Report Section (Initially Hidden) -->
        <div id="reportSection" class="hidden">
            <div class="report-card">
                <!-- Report Header -->
                <div class="report-header">
                    <h1 class="text-3xl font-bold text-blue-800">
                        First Trimester Maternal Serum Screening Report
                    </h1>
                    <p class="text-sm text-gray-600">Generated on: <span id="reportDateDisplay"></span></p>
                </div>
                
                <!-- Patient Information -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-blue-700 border-b pb-2 mb-4">
                        Patient Information
                    </h2>
                    <div class="bg-gray-50 p-4 rounded-md shadow-sm border text-sm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex">
                                <span class="w-40 font-medium text-gray-700">Patient Name:</span>
                                <span id="reportPatientName"></span>
                            </div>
                            <div class="flex">
                                <span class="w-40 font-medium text-gray-700">Patient ID:</span>
                                <span id="reportPatientId"></span>
                            </div>
                            <div class="flex">
                                <span class="w-40 font-medium text-gray-700">Date of Birth:</span>
                                <span id="reportDOB"></span>
                            </div>
                            <div class="flex">
                                <span class="w-40 font-medium text-gray-700">Gestational Age:</span>
                                <span id="reportGA"></span>
                            </div>
                            <div class="flex">
                                <span class="w-40 font-medium text-gray-700">Sample Collection:</span>
                                <span id="reportCollectionDate"></span>
                            </div>
                            <div class="flex">
                                <span class="w-40 font-medium text-gray-700">Ultrasound Date:</span>
                                <span id="reportUltrasoundDate"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Test Results -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-blue-700 border-b pb-2 mb-4">Test Results</h2>
                    <div class="overflow-x-auto">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Marker</th>
                                    <th>Result</th>
                                    <th>Median</th>
                                    <th>MoM</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Beta-hCG</td>
                                    <td id="reportHcgValue"></td>
                                    <td id="reportHcgMedian"></td>
                                    <td id="reportHcgMom"></td>
                                    <td id="reportHcgStatus"></td>
                                </tr>
                                <tr>
                                    <td>PAPP-A</td>
                                    <td id="reportPappaValue"></td>
                                    <td id="reportPappaMedian"></td>
                                    <td id="reportPappaMom"></td>
                                    <td id="reportPappaStatus"></td>
                                </tr>
                                <tr>
                                    <td>Nuchal Translucency</td>
                                    <td id="reportNtValue"></td>
                                    <td id="reportNtMedian"></td>
                                    <td id="reportNtMom"></td>
                                    <td id="reportNtStatus"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Risk Assessment -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-blue-700 border-b pb-2 mb-4">
                        Risk Assessment
                    </h2>
                    
                    <!-- Maternal Age Risks -->
                    <div class="risk-section">
                        <div class="risk-section-title">
                            <i class="fas fa-user-clock mr-2"></i>Maternal Age Risks
                        </div>
                        <div id="maternalAgeRisksContainer">
                            <!-- Content will be generated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Combined Risks -->
                    <div class="risk-section">
                        <div class="risk-section-title">
                            <i class="fas fa-dna mr-2"></i>Combined Risks (Serum Markers + Ultrasound)
                        </div>
                        <div id="combinedRisksContainer">
                            <!-- Content will be generated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Risk Visualization Chart -->
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
                
                <!-- Interpretation -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-blue-700 border-b pb-2 mb-4">Interpretation</h2>
                    <p class="text-gray-700" id="reportInterpretationText">
                        <!-- Content will be generated by JavaScript -->
                    </p>
                </div>
                
                <!-- Report Actions -->
                <div class="flex flex-wrap justify-between mt-8">
                    <button id="pdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-file-pdf mr-2"></i>Download PDF
                    </button>
                    <button id="newPatientBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-user-plus mr-2"></i>New Patient
                    </button>
                </div>
                
                <!-- Disclaimer -->
                <div class="disclaimer">
                    <p class="font-medium">Disclaimer:</p>
                    <p>This screening test provides a risk assessment and is not diagnostic. A high-risk result does not confirm the presence of an abnormality, and a low-risk result does not guarantee a normal outcome. All results should be interpreted in conjunction with clinical evaluation and other diagnostic tests if indicated. Consult a genetic counselor or specialist for further information.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="developed-by">
        <p>Developed by Clinicalsci | Medical Screening Solutions</p>
    </div>

    <script>
        // NT Medians Table
        const ntMedians = {
            10: [0.95, 0.97, 0.99, 1.01, 1.03, 1.05, 1.07],
            11: [1.10, 1.13, 1.15, 1.18, 1.20, 1.23, 1.26],
            12: [1.30, 1.36, 1.42, 1.48, 1.54, 1.60, 1.66],
            13: [1.73, 1.80, 1.88, 1.95, 2.03, 2.10, 2.18]
        };
        
        // Beta-hCG Medians
        const betaHcgMedians = {
            10: [176.95, 172.70, 168.55, 164.50, 160.55, 156.70, 152.93],
            11: [149.26, 145.68, 142.18, 138.76, 135.43, 132.18, 129.01],
            12: [125.91, 122.88, 119.93, 117.05, 114.24, 111.50, 108.82],
            13: [106.21, 103.66, 101.17, 98.74, 96.37, 94.05, 91.80]
        };
        
        // PAPP-A Medians
        const pappaMedians = {
            10: [777.13, 749.46, 727.25, 710.06, 697.57, 689.55, 685.84],
            11: [686.37, 691.15, 700.28, 713.92, 732.33, 755.86, 784.99],
            12: [820.28, 862.46, 912.43, 971.27, 1040.31, 1121.15, 1215.75],
            13: [1326.49, 1456.29, 1608.68, 1788.02, 1999.66, 2250.19, 2547.79]
        };
        
        // Base risks by maternal age
        const ageBasedRisks = {
            t21: {
                '<25': 1/1350,
                '25-29': 1/900,
                '30-34': 1/350,
                '35-39': 1/100,
                '≥40': 1/25
            },
            t18: {
                '<25': 1/5000,
                '25-29': 1/4000,
                '30-34': 1/2500,
                '35-39': 1/1000,
                '≥40': 1/500
            },
            t13: {
                '<25': 1/16000,
                '25-29': 1/12000,
                '30-34': 1/7000,
                '35-39': 1/2500,
                '≥40': 1/1000
            }
        };
        
        // DOM Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const reportSection = document.getElementById('reportSection');
        const pdfBtn = document.getElementById('pdfBtn');
        const newPatientBtn = document.getElementById('newPatientBtn');
        const calculateGA = document.getElementById('calculateGA');
        const forceGA = document.getElementById('forceGA');
        const calculatedGA = document.getElementById('calculatedGA');
        const finalGA = document.getElementById('finalGA');
        const dobInput = document.getElementById('dob');
        const calculatedAge = document.getElementById('calculatedAge');
        const collectionDateInput = document.getElementById('collectionDate');
        const ultrasoundDateInput = document.getElementById('ultrasoundDate');
        const reportDateInput = document.getElementById('reportDate');
        
        // Event Listeners
        calculateBtn.addEventListener('click', calculateRisk);
        pdfBtn.addEventListener('click', generatePDF);
        newPatientBtn.addEventListener('click', resetForm);
        calculateGA.addEventListener('click', calculateGAFromCRL);
        
        // Date calculations
        dobInput.addEventListener('change', calculateAgeFromDOB);
        collectionDateInput.addEventListener('change', calculateFinalGA);
        ultrasoundDateInput.addEventListener('change', calculateFinalGA);
        
        // Initialize with current date
        document.getElementById('reportDate').valueAsDate = new Date();
        
        // Calculate gestational age from CRL using Robinson method
        function calculateGAFromCRL() {
            const crl = parseFloat(document.getElementById('crl').value);
            if (!isNaN(crl)) {
                // Robinson formula: GA (days) = 8.052 * √(CRL) + 23.73
                const gaDays = 8.052 * Math.sqrt(crl) + 23.73;
                const weeks = Math.floor(gaDays / 7);
                const days = Math.round(gaDays % 7);
                
                if (weeks >= 10 && weeks <= 13) {
                    document.getElementById('weeks').value = weeks;
                    document.getElementById('days').value = days;
                    calculatedGA.textContent = `${weeks} weeks + ${days} days`;
                    calculateFinalGA();
                } else {
                    calculatedGA.textContent = "CRL out of range (10-13 weeks)";
                }
            } else {
                calculatedGA.textContent = "Enter valid CRL";
            }
        }
        
        // Calculate patient age from DOB including days
        function calculateAgeFromDOB() {
            const dob = new Date(dobInput.value);
            if (!isNaN(dob.getTime())) {
                const today = new Date();
                let years = today.getFullYear() - dob.getFullYear();
                let months = today.getMonth() - dob.getMonth();
                let days = today.getDate() - dob.getDate();
                
                if (days < 0) {
                    months--;
                    days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                }
                
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                const ageInDays = Math.floor((today - dob) / (1000 * 60 * 60 * 24));
                calculatedAge.textContent = `${years} years, ${months} months (${ageInDays} days)`;
                return { years, months, days: ageInDays };
            } else {
                calculatedAge.textContent = "Enter valid DOB";
                return null;
            }
        }
        
        // Calculate final GA adjusted for ultrasound and collection dates
        function calculateFinalGA() {
            const weeks = parseInt(document.getElementById('weeks').value);
            const days = parseInt(document.getElementById('days').value);
            const ultrasoundDate = new Date(ultrasoundDateInput.value);
            const collectionDate = new Date(collectionDateInput.value);
            
            if (isNaN(weeks) || isNaN(days) || isNaN(ultrasoundDate.getTime()) || isNaN(collectionDate.getTime())) {
                finalGA.textContent = "Complete all fields";
                return;
            }
            
            // Calculate GA at ultrasound in days
            const gaAtUltrasound = (weeks * 7) + days;
            
            // Calculate days difference between ultrasound and collection
            const timeDiff = collectionDate - ultrasoundDate;
            const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            // Adjust GA
            const finalGADays = gaAtUltrasound + dayDiff;
            const finalWeeks = Math.floor(finalGADays / 7);
            const finalDays = finalGADays % 7;
            
            finalGA.textContent = `${finalWeeks} weeks + ${finalDays} days`;
            
            return { weeks: finalWeeks, days: finalDays };
        }
        
        // Get NT median for given gestational age
        function getNTMedian(weeks, days) {
            if (ntMedians[weeks] && ntMedians[weeks][days]) {
                return ntMedians[weeks][days];
            }
            return 0;
        }
        
        // Get Beta-hCG median for given gestational age
        function getBetaHcgMedian(weeks, days) {
            if (betaHcgMedians[weeks] && betaHcgMedians[weeks][days]) {
                return betaHcgMedians[weeks][days];
            }
            return 0;
        }
        
        // Get PAPP-A median for given gestational age
        function getPappaMedian(weeks, days) {
            if (pappaMedians[weeks] && pappaMedians[weeks][days]) {
                return pappaMedians[weeks][days];
            }
            return 0;
        }
        
        // Get age-based risk
        function getAgeBasedRisk(age, condition) {
            if (age < 25) return ageBasedRisks[condition]['<25'];
            if (age < 30) return ageBasedRisks[condition]['25-29'];
            if (age < 35) return ageBasedRisks[condition]['30-34'];
            if (age < 40) return ageBasedRisks[condition]['35-39'];
            return ageBasedRisks[condition]['≥40'];
        }
        
        // Main calculation function
        function calculateRisk() {
            // Get input values
            const patientName = document.getElementById('patientName').value;
            const patientId = document.getElementById('patientId').value;
            const dob = document.getElementById('dob').value;
            const ethnicity = document.getElementById('ethnicity').value;
            const weeks = parseInt(document.getElementById('weeks').value);
            const days = parseInt(document.getElementById('days').value);
            const crl = parseFloat(document.getElementById('crl').value);
            const betaHcg = parseFloat(document.getElementById('betaHcg').value);
            const pappa = parseFloat(document.getElementById('pappa').value);
            const nt = parseFloat(document.getElementById('nt').value);
            const nasalBone = document.getElementById('nasalBone').value;
            const previousTrisomy = document.getElementById('previousTrisomy').value;
            const collectionDate = document.getElementById('collectionDate').value;
            const ultrasoundDate = document.getElementById('ultrasoundDate').value;
            const reportDate = document.getElementById('reportDate').value;
            
            // Validate inputs
            if (!patientName || !weeks || !days || isNaN(betaHcg) || isNaN(pappa) || isNaN(nt) || !dob) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (weeks < 10 || weeks > 13) {
                alert('Gestational age must be between 10+0 and 13+6 weeks');
                return;
            }
            
            if (days < 0 || days > 6) {
                alert('Days must be between 0 and 6');
                return;
            }
            
            // Calculate maternal age
            const ageInfo = calculateAgeFromDOB();
            if (!ageInfo) {
                alert('Please enter a valid date of birth');
                return;
            }
            
            // Calculate final GA
            const finalGA = calculateFinalGA();
            if (!finalGA) {
                alert('Please enter valid dates for ultrasound and collection');
                return;
            }
            
            // Get medians
            const ntMedian = getNTMedian(finalGA.weeks, finalGA.days);
            const betaHcgMedian = getBetaHcgMedian(finalGA.weeks, finalGA.days);
            const pappaMedian = getPappaMedian(finalGA.weeks, finalGA.days);
            
            // Calculate MoMs
            const ntMom = nt / ntMedian;
            const betaHcgMom = betaHcg / betaHcgMedian;
            const pappaMom = pappa / pappaMedian;
            
            // Get age-based risks
            const ageRiskT21 = getAgeBasedRisk(ageInfo.years, 't21');
            const ageRiskT18 = getAgeBasedRisk(ageInfo.years, 't18');
            const ageRiskT13 = getAgeBasedRisk(ageInfo.years, 't13');
            
            // Calculate combined risks
            const combinedRiskT21 = calculateRiskT21(ageInfo.years, previousTrisomy === 'yes', betaHcgMom, pappaMom, ntMom, nasalBone);
            const combinedRiskT18 = calculateRiskT18(ageInfo.years, previousTrisomy === 'yes', betaHcgMom, pappaMom, ntMom);
            const combinedRiskT13 = calculateRiskT13(ageInfo.years, previousTrisomy === 'yes', betaHcgMom, pappaMom, ntMom);
            
            // Display report
            displayReport(
                patientName, patientId, dob, ageInfo,
                betaHcg, pappa, nt,
                ntMedian, betaHcgMedian, pappaMedian,
                ntMom, betaHcgMom, pappaMom,
                {
                    t21: ageRiskT21,
                    t18: ageRiskT18,
                    t13: ageRiskT13
                },
                {
                    t21: combinedRiskT21,
                    t18: combinedRiskT18,
                    t13: combinedRiskT13
                },
                collectionDate, ultrasoundDate, reportDate,
                finalGA
            );
            
            // Show report section
            reportSection.classList.remove('hidden');
            
            // Scroll to report
            reportSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Risk calculation functions
        function calculateRiskT21(age, prevTrisomy, hcgMom, pappaMom, ntMom, nasalBone) {
            // Start with age-based risk
            let risk = getAgeBasedRisk(age, 't21');
            
            // Adjust for previous trisomy
            if (prevTrisomy) risk *= 1.5;
            
            // Adjust for biomarkers
            if (hcgMom > 2.5) risk *= 1.8;
            if (pappaMom < 0.5) risk *= 2.2;
            
            // Adjust for NT
            if (ntMom > 1.5) risk *= ntMom * 1.5;
            
            // Adjust for nasal bone
            if (nasalBone === 'absent') risk *= 5;
            
            return risk;
        }
        
        function calculateRiskT18(age, prevTrisomy, hcgMom, pappaMom, ntMom) {
            // Start with age-based risk
            let risk = getAgeBasedRisk(age, 't18');
            
            // Adjust for previous trisomy
            if (prevTrisomy) risk *= 1.5;
            
            // Adjust for biomarkers
            if (hcgMom < 0.3) risk *= 3;
            if (pappaMom < 0.3) risk *= 4;
            
            // Adjust for NT
            if (ntMom > 2.0) risk *= ntMom * 2;
            
            return risk;
        }
        
        function calculateRiskT13(age, prevTrisomy, hcgMom, pappaMom, ntMom) {
            // Start with age-based risk
            let risk = getAgeBasedRisk(age, 't13');
            
            // Adjust for previous trisomy
            if (prevTrisomy) risk *= 1.5;
            
            // Adjust for biomarkers
            if (hcgMom < 0.4) risk *= 2.5;
            if (pappaMom < 0.4) risk *= 3;
            
            // Adjust for NT
            if (ntMom > 1.8) risk *= ntMom * 1.8;
            
            return risk;
        }
        
        // Display report function
        function displayReport(
            patientName, patientId, dob, ageInfo,
            betaHcg, pappa, nt,
            ntMedian, betaHcgMedian, pappaMedian,
            ntMom, betaHcgMom, pappaMom,
            ageRisks,
            combinedRisks,
            collectionDate, ultrasoundDate, reportDate,
            finalGA
        ) {
            // Format patient info
            document.getElementById('reportPatientName').textContent = patientName;
            document.getElementById('reportPatientId').textContent = patientId || 'N/A';
            document.getElementById('reportDOB').textContent = dob ? new Date(dob).toLocaleDateString() : 'N/A';
            document.getElementById('reportGA').textContent = `${finalGA.weeks} weeks + ${finalGA.days} days`;
            document.getElementById('reportCollectionDate').textContent = collectionDate ? new Date(collectionDate).toLocaleDateString() : 'N/A';
            document.getElementById('reportUltrasoundDate').textContent = ultrasoundDate ? new Date(ultrasoundDate).toLocaleDateString() : 'N/A';
            document.getElementById('reportDateDisplay').textContent = reportDate ? new Date(reportDate).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Fill detailed results
            document.getElementById('reportHcgValue').textContent = betaHcg.toFixed(2) + ' IU/ml';
            document.getElementById('reportHcgMedian').textContent = betaHcgMedian.toFixed(2) + ' IU/ml';
            document.getElementById('reportHcgMom').textContent = betaHcgMom.toFixed(2) + ' MoM';
            document.getElementById('reportHcgStatus').textContent = getStatus(betaHcgMom, 0.4, 2.5);
            
            document.getElementById('reportPappaValue').textContent = pappa.toFixed(2) + ' ng/mL';
            document.getElementById('reportPappaMedian').textContent = pappaMedian.toFixed(2) + ' ng/mL';
            document.getElementById('reportPappaMom').textContent = pappaMom.toFixed(2) + ' MoM';
            document.getElementById('reportPappaStatus').textContent = getStatus(pappaMom, 0.5, 2.0);
            
            document.getElementById('reportNtValue').textContent = nt.toFixed(2) + ' mm';
            document.getElementById('reportNtMedian').textContent = ntMedian.toFixed(2) + ' mm';
            document.getElementById('reportNtMom').textContent = ntMom.toFixed(2) + ' MoM';
            document.getElementById('reportNtStatus').textContent = getNtStatus(nt, ntMedian);
            
            // Set status colors
            setStatusColor('reportHcgStatus');
            setStatusColor('reportPappaStatus');
            setStatusColor('reportNtStatus');
            
            // Create risk visualization chart
            createRiskChart(combinedRisks.t21, combinedRisks.t18, combinedRisks.t13);
            
            // Set interpretation
            setInterpretation(combinedRisks.t21, combinedRisks.t18, combinedRisks.t13, nt, nasalBone, ageInfo, ageRisks.t21, combinedRisks.t21);
            
            // Add maternal age risks to the report
            addMaternalAgeRisks(ageInfo.years, ageRisks);
            
            // Add combined risks to the report
            addCombinedRisks(combinedRisks);
        }
        
        function formatRisk(risk) {
            if (risk >= 1) return "1:1";
            if (risk <= 0) return "1:∞";
            
            const inverse = Math.round(1 / risk);
            return `1:${inverse.toLocaleString()}`;
        }
        
        function getRiskCategory(risk, isT21 = false) {
            const inverseRisk = 1 / risk;
            
            if (isT21) {
                if (inverseRisk <= 300) return { text: "High", class: "risk-high" };
                if (inverseRisk <= 350) return { text: "Moderate", class: "risk-moderate" };
                return { text: "Low", class: "risk-low" };
            } else {
                if (inverseRisk <= 50) return { text: "High", class: "risk-high" };
                if (inverseRisk <= 1000) return { text: "Moderate", class: "risk-moderate" };
                return { text: "Low", class: "risk-low" };
            }
        }
        
        function getStatus(value, min, max) {
            if (value < min) return "Low";
            if (value > max) return "High";
            return "Normal";
        }
        
        function getNtStatus(nt, median) {
            if (nt > median * 1.8) return "High";
            if (nt < median * 0.8) return "Low";
            return "Normal";
        }
        
        function setStatusColor(elementId) {
            const element = document.getElementById(elementId);
            if (element.textContent === "Low" || element.textContent === "High") {
                element.className = "text-red-600 font-medium";
            } else {
                element.className = "text-green-600 font-medium";
            }
        }
        
        function createRiskChart(riskT21, riskT18, riskT13) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (window.riskChartInstance) {
                window.riskChartInstance.destroy();
            }
            
            // Calculate inverse risks for visualization
            const invT21 = 1 / riskT21;
            const invT18 = 1 / riskT18;
            const invT13 = 1 / riskT13;
            
            window.riskChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Trisomy 21', 'Trisomy 18', 'Trisomy 13'],
                    datasets: [{
                        label: 'Risk Score (1 in X)',
                        data: [invT21, invT18, invT13],
                        backgroundColor: [
                            invT21 <= 300 ? 'rgba(239, 68, 68, 0.7)' : 
                                invT21 <= 350 ? 'rgba(234, 179, 8, 0.7)' : 'rgba(34, 197, 94, 0.7)',
                            invT18 <= 50 ? 'rgba(239, 68, 68, 0.7)' : 
                                invT18 <= 1000 ? 'rgba(234, 179, 8, 0.7)' : 'rgba(34, 197, 94, 0.7)',
                            invT13 <= 50 ? 'rgba(239, 68, 68, 0.7)' : 
                                invT13 <= 1000 ? 'rgba(234, 179, 8, 0.7)' : 'rgba(34, 197, 94, 0.7)'
                        ],
                        borderColor: [
                            invT21 <= 300 ? 'rgba(239, 68, 68, 1)' : 
                                invT21 <= 350 ? 'rgba(234, 179, 8, 1)' : 'rgba(34, 197, 94, 1)',
                            invT18 <= 50 ? 'rgba(239, 68, 68, 1)' : 
                                invT18 <= 1000 ? 'rgba(234, 179, 8, 1)' : 'rgba(34, 197, 94, 1)',
                            invT13 <= 50 ? 'rgba(239, 68, 68, 1)' : 
                                invT13 <= 1000 ? 'rgba(234, 179, 8, 1)' : 'rgba(34, 197, 94, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Risk Score (1 in X)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `1 in ${Math.round(context.raw).toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function setInterpretation(riskT21, riskT18, riskT13, nt, nasalBone, ageInfo, ageRiskT21, combinedRiskT21) {
            const interpretationText = document.getElementById('reportInterpretationText');
            
            // Base interpretation
            let interpretation = "The results of the first trimester maternal serum screening indicate ";
            
            // Risk level determination for T21 with updated thresholds
            const inverseRiskT21 = 1 / riskT21;
            let riskLevel = "low";
            
            if (inverseRiskT21 <= 300) {
                riskLevel = "high";
            } else if (inverseRiskT21 <= 350) {
                riskLevel = "moderate";
            }
            
            interpretation += `a ${riskLevel} risk for chromosomal abnormalities such as Trisomy 21, 18, and 13. `;
            
            // Add age information
            interpretation += `Based on maternal age (${ageInfo.years} years), the background risk for Down Syndrome was ${formatRisk(ageRiskT21)}. `;
            
            // Add information about risk modification
            const riskModification = combinedRiskT21 / ageRiskT21;
            if (riskModification > 1.5) {
                interpretation += "Screening markers have significantly increased this risk. ";
            } else if (riskModification < 0.67) {
                interpretation += "Screening markers have significantly decreased this risk. ";
            } else {
                interpretation += "Screening markers have had minimal effect on this age-related risk. ";
            }
            
            // Add specific findings
            if (nt > 3.5) {
                interpretation += "The nuchal translucency measurement is significantly increased, which may indicate an increased risk for chromosomal abnormalities or congenital heart defects. ";
            } else if (nt > 2.5) {
                interpretation += "The nuchal translucency measurement is mildly increased. ";
            }
            
            if (nasalBone === 'absent') {
                interpretation += "The fetal nasal bone appears absent, which is a soft marker for trisomy 21. ";
            }
            
            interpretation += "This screening test has a detection rate of approximately 90% for trisomy 21 with a 5% false-positive rate. ";
            
            if (riskLevel === "low") {
                interpretation += "No further diagnostic testing is recommended at this time, but regular prenatal care should continue.";
            } else if (riskLevel === "moderate") {
                interpretation += "Non-invasive prenatal testing (NIPT) should be considered as a follow-up test.";
            } else {
                interpretation += "Invasive diagnostic testing (CVS or amniocentesis) should be offered due to high risk.";
            }
            
            interpretationText.textContent = interpretation;
        }
        
        // Add maternal age risks to the report
        function addMaternalAgeRisks(age, risks) {
            const container = document.getElementById('maternalAgeRisksContainer');
            container.innerHTML = `
                <table class="report-table maternal-risk-table">
                    <thead>
                        <tr>
                            <th>Condition</th>
                            <th>Risk</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Trisomy 21 (Down Syndrome)</td>
                            <td>${formatRisk(risks.t21)}</td>
                        </tr>
                        <tr>
                            <td>Trisomy 18 (Edwards Syndrome)</td>
                            <td>${formatRisk(risks.t18)}</td>
                        </tr>
                        <tr>
                            <td>Trisomy 13 (Patau Syndrome)</td>
                            <td>${formatRisk(risks.t13)}</td>
                        </tr>
                    </tbody>
                </table>
                <p class="text-sm text-gray-600 mt-2">* Based solely on maternal age: ${age} years</p>
            `;
        }
        
        // Add combined risks to the report
        function addCombinedRisks(risks) {
            const container = document.getElementById('combinedRisksContainer');
            
            const t21Risk = getRiskCategory(risks.t21, true);
            const t18Risk = getRiskCategory(risks.t18);
            const t13Risk = getRiskCategory(risks.t13);
            
            container.innerHTML = `
                <table class="report-table combined-risk-table">
                    <thead>
                        <tr>
                            <th>Condition</th>
                            <th>Risk</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Trisomy 21 (Down Syndrome)</td>
                            <td>${formatRisk(risks.t21)}</td>
                            <td><span class="${t21Risk.class} px-2 py-1 rounded-md">${t21Risk.text}</span></td>
                        </tr>
                        <tr>
                            <td>Trisomy 18 (Edwards Syndrome)</td>
                            <td>${formatRisk(risks.t18)}</td>
                            <td><span class="${t18Risk.class} px-2 py-1 rounded-md">${t18Risk.text}</span></td>
                        </tr>
                        <tr>
                            <td>Trisomy 13 (Patau Syndrome)</td>
                            <td>${formatRisk(risks.t13)}</td>
                            <td><span class="${t13Risk.class} px-2 py-1 rounded-md">${t13Risk.text}</span></td>
                        </tr>
                    </tbody>
                </table>
                <p class="text-sm text-gray-600 mt-2">* Combined risk includes maternal age, serum markers, ultrasound findings, and other risk factors</p>
            `;
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // Capture the report card
            html2canvas(document.querySelector('.report-card'), {
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth() - 40;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
                
                // Add footer
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Developed by Clinicalsci | Medical Screening Solutions', 
                    doc.internal.pageSize.getWidth()/2, doc.internal.pageSize.getHeight() - 20, 
                    {align: 'center'});
                
                // Save the PDF
                doc.save('First_Trimester_Screening_Report.pdf');
            });
        }
        
        function resetForm() {
            // Clear all form fields
            document.getElementById('patientName').value = '';
            document.getElementById('patientId').value = '';
            document.getElementById('dob').value = '';
            document.getElementById('ethnicity').selectedIndex = 0;
            document.getElementById('crl').value = '';
            document.getElementById('weeks').value = '';
            document.getElementById('days').value = '';
            document.getElementById('betaHcg').value = '';
            document.getElementById('pappa').value = '';
            document.getElementById('nt').value = '';
            document.getElementById('nasalBone').selectedIndex = 0;
            document.getElementById('previousTrisomy').selectedIndex = 0;
            document.getElementById('collectionDate').value = '';
            document.getElementById('ultrasoundDate').value = '';
            document.getElementById('calculatedGA').textContent = 'Enter CRL to calculate';
            document.getElementById('finalGA').textContent = 'Not calculated';
            document.getElementById('calculatedAge').textContent = 'Enter DOB to calculate';
            document.getElementById('forceGA').checked = false;
            
            // Hide report section
            reportSection.classList.add('hidden');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
