<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Trimester Screening</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #resultsSection, #resultsSection * {
                visibility: visible;
            }
            #resultsSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
            .report-container {
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .print-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            .print-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #1e40af;
                padding-bottom: 10px;
            }
            .print-header img {
                height: 60px;
            }
        }
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .risk-high {
            background-color: rgba(239, 68, 68, 0.2);
            border-left: 4px solid rgb(239, 68, 68);
        }
        .risk-moderate {
            background-color: rgba(234, 179, 8, 0.2);
            border-left: 4px solid rgb(234, 179, 8);
        }
        .risk-low {
            background-color: rgba(34, 197, 94, 0.2);
            border-left: 4px solid rgb(34, 197, 94);
        }
        .ga-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chart-container {
            height: 200px;
            margin: 20px 0;
        }
        .disclaimer {
            background-color: #f3f4f6;
            border-top: 2px solid #e5e7eb;
            padding: 15px;
            font-size: 0.8rem;
            color: #6b7280;
            text-align: center;
            margin-top: 20px;
        }
        .developed-by {
            text-align: center;
            padding: 10px;
            font-size: 0.85rem;
            color: #4b5563;
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-blue-700 to-indigo-800 px-6 py-4">
                <h1 class="text-2xl font-bold text-white">First Trimester Screening</h1>
                <p class="text-blue-100">Comprehensive risk assessment for chromosomal abnormalities</p>
            </div>
            
            <div class="p-6">
                <!-- Patient Information -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-user-circle mr-2 text-blue-600"></i>Patient Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Patient Name</label>
                            <input type="text" id="patientName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Patient ID</label>
                            <input type="text" id="patientId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                            <input type="date" id="dob" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ethnicity</label>
                            <select id="ethnicity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="asian">Asian</option>
                                <option value="caucasian">Caucasian</option>
                                <option value="african">African</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Pregnancy Details -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-baby mr-2 text-pink-500"></i>Pregnancy Details
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Menstrual Period (LMP)</label>
                            <input type="date" id="lmp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex flex-col">
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-medium text-gray-700">CRL (mm)</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="forceGA" class="mr-1">
                                    <label for="forceGA" class="text-xs text-gray-500">Force GA</label>
                                </div>
                            </div>
                            <input type="number" id="crl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Crown-rump length">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gestational Age (weeks+days)</label>
                            <div class="flex ga-controls">
                                <div class="flex w-full">
                                    <input type="number" id="weeks" min="10" max="13" class="w-1/2 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Weeks">
                                    <input type="number" id="days" min="0" max="6" class="w-1/2 px-3 py-2 border border-gray-300 rounded-r-md border-l-0 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Days">
                                </div>
                                <button id="calculateGA" class="ml-2 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    <i class="fas fa-calculator"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estimated GA from CRL</label>
                            <div class="px-3 py-2 bg-gray-100 rounded-md" id="calculatedGA">
                                Enter CRL to calculate
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Biochemical Markers -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-flask mr-2 text-green-600"></i>Biochemical Markers
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Beta-hCG (IU/ml)</label>
                            <input type="number" step="0.01" id="betaHcg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PAPP-A (ng/mL)</label>
                            <input type="number" step="0.01" id="pappa" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- Ultrasound Findings -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-procedures mr-2 text-purple-600"></i>Ultrasound Findings
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nuchal Translucency (mm)</label>
                            <input type="number" step="0.1" id="nt" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nasal Bone</label>
                            <select id="nasalBone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tricuspid Flow</label>
                            <select id="tricuspidFlow" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="normal">Normal</option>
                                <option value="regurgitation">Regurgitation</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Factors -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">
                        <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>Risk Factors
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Maternal Age</label>
                            <input type="number" id="maternalAge" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Previous Trisomy</label>
                            <select id="previousTrisomy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Calculate Button -->
                <div class="flex justify-center mt-8">
                    <button id="calculateBtn" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-calculator mr-2"></i>Calculate Risk
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Section (Initially Hidden) -->
        <div id="resultsSection" class="hidden bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-green-600 to-teal-700 px-6 py-4">
                <h2 class="text-2xl font-bold text-white">Screening Results</h2>
                <p class="text-green-100">First Trimester Combined Screening Report</p>
            </div>
            
            <div class="p-6">
                <!-- Patient Summary -->
                <div class="mb-6">
                    <div class="print-header">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Fetal Health Screening Report</h3>
                            <p class="text-gray-600">Comprehensive First Trimester Assessment</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Report Date: <span id="reportDate"></span></p>
                            <p class="text-sm text-gray-600">Patient ID: <span id="resultId"></span></p>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Patient Summary</h3>
                    <div class="bg-gray-50 p-4 rounded-md print-grid">
                        <div>
                            <p class="text-sm text-gray-600">Patient Name:</p>
                            <p id="resultName" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Date of Birth:</p>
                            <p id="resultDob" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Ethnicity:</p>
                            <p id="resultEthnicity" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Maternal Age:</p>
                            <p id="resultMaternalAge" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Gestational Age:</p>
                            <p id="resultGestationalAge" class="font-medium"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">CRL:</p>
                            <p id="resultCRL" class="font-medium"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Assessment -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Risk Assessment</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 print-grid">
                        <div id="t21Risk" class="p-4 rounded-md">
                            <p class="text-sm font-medium mb-1">Trisomy 21 (Down Syndrome)</p>
                            <p class="text-2xl font-bold" id="t21RiskValue">1:0</p>
                            <p class="text-sm" id="t21RiskCategory"></p>
                        </div>
                        <div id="t18Risk" class="p-4 rounded-md">
                            <p class="text-sm font-medium mb-1">Trisomy 18 (Edwards Syndrome)</p>
                            <p class="text-2xl font-bold" id="t18RiskValue">1:0</p>
                            <p class="text-sm" id="t18RiskCategory"></p>
                        </div>
                        <div id="t13Risk" class="p-4 rounded-md">
                            <p class="text-sm font-medium mb-1">Trisomy 13 (Patau Syndrome)</p>
                            <p class="text-2xl font-bold" id="t13RiskValue">1:0</p>
                            <p class="text-sm" id="t13RiskCategory"></p>
                        </div>
                    </div>
                    
                    <!-- Risk Visualization Chart -->
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
                
                <!-- Detailed Results -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Detailed Results</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parameter</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Median</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MoM</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr>
                                    <td class="px-4 py-2">Beta-hCG</td>
                                    <td class="px-4 py-2" id="hcgValue"></td>
                                    <td class="px-4 py-2" id="hcgMedian"></td>
                                    <td class="px-4 py-2" id="hcgMom"></td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">PAPP-A</td>
                                    <td class="px-4 py-2" id="pappaValue"></td>
                                    <td class="px-4 py-2" id="pappaMedian"></td>
                                    <td class="px-4 py-2" id="pappaMom"></td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2">Nuchal Translucency</td>
                                    <td class="px-4 py-2" id="ntValue"></td>
                                    <td class="px-4 py-2">-</td>
                                    <td class="px-4 py-2" id="ntMom"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Interpretation -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Interpretation</h3>
                    <div class="bg-gray-50 p-4 rounded-md">
                        <p class="text-sm text-gray-700" id="interpretationText">
                            The risk assessment is based on maternal age, fetal nuchal translucency measurement, and maternal serum biochemistry (free β-hCG and PAPP-A). This screening test has a detection rate of approximately 90% for trisomy 21 with a 5% false-positive rate.
                        </p>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-gray-700">Risk Categories:</p>
                            <ul class="list-disc pl-5 text-sm text-gray-700 mt-1">
                                <li><span class="font-medium">High Risk:</span> ≥ 1 in 50</li>
                                <li><span class="font-medium">Moderate Risk:</span> 1 in 51 to 1 in 1000</li>
                                <li><span class="font-medium">Low Risk:</span> < 1 in 1000</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 border-b pb-2">Recommendations</h3>
                    <div class="bg-gray-50 p-4 rounded-md">
                        <p class="text-sm text-gray-700" id="recommendationText">
                            Based on the screening results, the following recommendations are provided:
                        </p>
                        <ul class="list-disc pl-5 text-sm text-gray-700 mt-2" id="recommendationsList">
                            <!-- Will be filled by JavaScript -->
                        </ul>
                    </div>
                </div>
                
                <!-- Report Actions -->
                <div class="flex flex-wrap justify-between mt-8 no-print">
                    <button id="printBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-print mr-2"></i>Print Report
                    </button>
                    <button id="pdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-file-pdf mr-2"></i>Download PDF
                    </button>
                    <button id="newPatientBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out mb-2">
                        <i class="fas fa-user-plus mr-2"></i>New Patient
                    </button>
                </div>
                
                <!-- Disclaimer -->
                <div class="disclaimer no-print">
                    <p class="font-medium">Disclaimer:</p>
                    <p>This screening test provides a risk assessment and is not diagnostic. A high-risk result does not confirm the presence of an abnormality, and a low-risk result does not guarantee a normal outcome. All results should be interpreted in conjunction with clinical evaluation and other diagnostic tests if indicated. Consult a genetic counselor or specialist for further information.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="developed-by">
        <p>Developed by Clinicalsci | Medical Screening Solutions</p>
    </div>

    <script>
        // Define the median tables
        const betaHcgMedians = {
            10: [176.95, 172.70, 168.55, 164.50, 160.55, 156.70, 152.93],
            11: [149.26, 145.68, 142.18, 138.76, 135.43, 132.18, 129.01],
            12: [125.91, 122.88, 119.93, 117.05, 114.24, 111.50, 108.82],
            13: [106.21, 103.66, 101.17, 98.74, 96.37, 94.05, 91.80]
        };
        
        const pappaMedians = {
            10: [777.13, 749.46, 727.25, 710.06, 697.57, 689.55, 685.84],
            11: [686.37, 691.15, 700.28, 713.92, 732.33, 755.86, 784.99],
            12: [820.28, 862.46, 912.43, 971.27, 1040.31, 1121.15, 1215.75],
            13: [1326.49, 1456.29, 1608.68, 1788.02, 1999.66, 2250.19, 2547.79]
        };
        
        // DOM Elements
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsSection = document.getElementById('resultsSection');
        const printBtn = document.getElementById('printBtn');
        const pdfBtn = document.getElementById('pdfBtn');
        const newPatientBtn = document.getElementById('newPatientBtn');
        const calculateGA = document.getElementById('calculateGA');
        const forceGA = document.getElementById('forceGA');
        const calculatedGA = document.getElementById('calculatedGA');
        
        // Event Listeners
        calculateBtn.addEventListener('click', calculateRisk);
        printBtn.addEventListener('click', printReport);
        pdfBtn.addEventListener('click', generatePDF);
        newPatientBtn.addEventListener('click', resetForm);
        calculateGA.addEventListener('click', calculateGAFromCRL);
        
        // Calculate gestational age from LMP and CRL
        document.getElementById('lmp').addEventListener('change', function() {
            const lmp = new Date(this.value);
            if (!isNaN(lmp.getTime())) {
                const today = new Date();
                const diffTime = Math.abs(today - lmp);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const weeks = Math.floor(diffDays / 7);
                const days = diffDays % 7;
                
                if (weeks >= 10 && weeks <= 13) {
                    document.getElementById('weeks').value = weeks;
                    document.getElementById('days').value = days;
                }
            }
        });
        
        // Calculate CRL to gestational age using Robinson method
        document.getElementById('crl').addEventListener('input', function() {
            if (forceGA.checked) return;
            calculateGAFromCRL();
        });
        
        // Toggle force GA
        forceGA.addEventListener('change', function() {
            if (!this.checked) {
                calculateGAFromCRL();
            }
        });
        
        // Function to calculate GA using Robinson method
        function calculateGAFromCRL() {
            const crl = parseFloat(document.getElementById('crl').value);
            if (!isNaN(crl)) {
                // Robinson formula: GA (days) = 8.052 * √(CRL) + 23.73
                const gaDays = 8.052 * Math.sqrt(crl) + 23.73;
                const weeks = Math.floor(gaDays / 7);
                const days = Math.round(gaDays % 7);
                
                if (weeks >= 10 && weeks <= 13) {
                    document.getElementById('weeks').value = weeks;
                    document.getElementById('days').value = days;
                    calculatedGA.textContent = `${weeks} weeks + ${days} days`;
                } else {
                    calculatedGA.textContent = "CRL out of range (10-13 weeks)";
                }
            } else {
                calculatedGA.textContent = "Enter valid CRL";
            }
        }
        
        // Main calculation function
        function calculateRisk() {
            // Get input values
            const patientName = document.getElementById('patientName').value;
            const patientId = document.getElementById('patientId').value;
            const dob = document.getElementById('dob').value;
            const ethnicity = document.getElementById('ethnicity').value;
            const weeks = parseInt(document.getElementById('weeks').value);
            const days = parseInt(document.getElementById('days').value);
            const crl = parseFloat(document.getElementById('crl').value);
            const betaHcg = parseFloat(document.getElementById('betaHcg').value);
            const pappa = parseFloat(document.getElementById('pappa').value);
            const nt = parseFloat(document.getElementById('nt').value);
            const nasalBone = document.getElementById('nasalBone').value;
            const tricuspidFlow = document.getElementById('tricuspidFlow').value;
            const maternalAge = parseInt(document.getElementById('maternalAge').value);
            const previousTrisomy = document.getElementById('previousTrisomy').value;
            
            // Validate inputs
            if (!patientName || !weeks || !days || isNaN(betaHcg) || isNaN(pappa) || isNaN(nt) || !maternalAge) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (weeks < 10 || weeks > 13) {
                alert('Gestational age must be between 10+0 and 13+6 weeks');
                return;
            }
            
            if (days < 0 || days > 6) {
                alert('Days must be between 0 and 6');
                return;
            }
            
            // Get medians based on gestational age
            const betaHcgMedian = betaHcgMedians[weeks][days];
            const pappaMedian = pappaMedians[weeks][days];
            
            // Calculate MoMs
            const betaHcgMom = betaHcg / betaHcgMedian;
            const pappaMom = pappa / pappaMedian;
            const ntMom = nt / getExpectedNT(weeks, days);
            
            // Calculate risks (simplified for demo)
            // In a real application, this would use complex algorithms and likelihood ratios
            const baseRiskT21 = calculateBaseRiskT21(maternalAge, previousTrisomy === 'yes');
            const adjustedRiskT21 = adjustRiskT21(baseRiskT21, betaHcgMom, pappaMom, ntMom, nasalBone, tricuspidFlow);
            
            const baseRiskT18 = calculateBaseRiskT18(maternalAge);
            const adjustedRiskT18 = adjustRiskT18(baseRiskT18, betaHcgMom, pappaMom, ntMom);
            
            const baseRiskT13 = calculateBaseRiskT13(maternalAge);
            const adjustedRiskT13 = adjustRiskT13(baseRiskT13, betaHcgMom, pappaMom, ntMom);
            
            // Display results
            displayResults(
                patientName, patientId, dob, ethnicity, maternalAge,
                weeks, days, crl, betaHcg, pappa, nt, nasalBone, tricuspidFlow,
                betaHcgMedian, pappaMedian, betaHcgMom, pappaMom, ntMom,
                adjustedRiskT21, adjustedRiskT18, adjustedRiskT13
            );
            
            // Show results section
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Helper functions for risk calculation
        function getExpectedNT(weeks, days) {
            // Simplified expected NT values by gestational age
            const gaDays = weeks * 7 + days;
            return 0.0003 * Math.pow(gaDays, 2) - 0.0098 * gaDays + 1.3038;
        }
        
        function calculateBaseRiskT21(maternalAge, hasPreviousTrisomy) {
            // Based on age-related risk tables
            let risk;
            if (maternalAge < 20) risk = 1/1527;
            else if (maternalAge < 25) risk = 1/1352;
            else if (maternalAge < 30) risk = 1/895;
            else if (maternalAge < 35) risk = 1/355;
            else if (maternalAge < 40) risk = 1/97;
            else if (maternalAge < 45) risk = 1/30;
            else risk = 1/10;
            
            // Adjust for previous trisomy
            if (hasPreviousTrisomy) risk *= 0.75;
            
            return risk;
        }
        
        function calculateBaseRiskT18(maternalAge) {
            // Simplified age-related risk
            return 1 / (5000 - (maternalAge * 50));
        }
        
        function calculateBaseRiskT13(maternalAge) {
            // Simplified age-related risk
            return 1 / (10000 - (maternalAge * 100));
        }
        
        function adjustRiskT21(baseRisk, betaHcgMom, pappaMom, ntMom, nasalBone, tricuspidFlow) {
            // Simplified adjustment based on marker levels
            let risk = baseRisk;
            
            // Adjust for biochemical markers
            if (betaHcgMom > 2.5) risk *= 2;
            else if (betaHcgMom < 0.5) risk *= 0.5;
            
            if (pappaMom < 0.5) risk *= 2;
            else if (pappaMom > 2) risk *= 0.8;
            
            // Adjust for NT
            if (ntMom > 1.8) risk *= ntMom * 1.5;
            else if (ntMom < 0.8) risk *= 0.7;
            
            // Adjust for nasal bone
            if (nasalBone === 'absent') risk *= 10;
            
            // Adjust for tricuspid flow
            if (tricuspidFlow === 'regurgitation') risk *= 5;
            
            return risk;
        }
        
        function adjustRiskT18(baseRisk, betaHcgMom, pappaMom, ntMom) {
            // Simplified adjustment for T18
            let risk = baseRisk;
            
            if (betaHcgMom < 0.3) risk *= 3;
            if (pappaMom < 0.3) risk *= 4;
            if (ntMom > 2) risk *= ntMom * 2;
            
            return risk;
        }
        
        function adjustRiskT13(baseRisk, betaHcgMom, pappaMom, ntMom) {
            // Simplified adjustment for T13
            let risk = baseRisk;
            
            if (betaHcgMom < 0.4) risk *= 2;
            if (pappaMom < 0.4) risk *= 2.5;
            if (ntMom > 1.5) risk *= ntMom * 1.8;
            
            return risk;
        }
        
        // Display results function
        function displayResults(
            patientName, patientId, dob, ethnicity, maternalAge,
            weeks, days, crl, betaHcg, pappa, nt, nasalBone, tricuspidFlow,
            betaHcgMedian, pappaMedian, betaHcgMom, pappaMom, ntMom,
            riskT21, riskT18, riskT13
        ) {
            // Format patient info
            document.getElementById('resultName').textContent = patientName;
            document.getElementById('resultId').textContent = patientId || 'N/A';
            document.getElementById('resultDob').textContent = dob ? new Date(dob).toLocaleDateString() : 'N/A';
            document.getElementById('resultEthnicity').textContent = document.getElementById('ethnicity').options[document.getElementById('ethnicity').selectedIndex].text;
            document.getElementById('resultMaternalAge').textContent = maternalAge + ' years';
            document.getElementById('resultGestationalAge').textContent = `${weeks}+${days} weeks`;
            document.getElementById('resultCRL').textContent = isNaN(crl) ? 'N/A' : crl.toFixed(1) + ' mm';
            
            // Format risks
            const formattedRiskT21 = formatRisk(riskT21);
            const formattedRiskT18 = formatRisk(riskT18);
            const formattedRiskT13 = formatRisk(riskT13);
            
            document.getElementById('t21RiskValue').textContent = formattedRiskT21;
            document.getElementById('t18RiskValue').textContent = formattedRiskT18;
            document.getElementById('t13RiskValue').textContent = formattedRiskT13;
            
            // Set report date
            const now = new Date();
            document.getElementById('reportDate').textContent = now.toLocaleDateString();
            
            // Set risk categories and styling
            setRiskCategory('t21Risk', riskT21);
            setRiskCategory('t18Risk', riskT18);
            setRiskCategory('t13Risk', riskT13);
            
            // Fill detailed results
            document.getElementById('hcgValue').textContent = betaHcg.toFixed(2);
            document.getElementById('hcgMedian').textContent = betaHcgMedian.toFixed(2);
            document.getElementById('hcgMom').textContent = betaHcgMom.toFixed(2);
            
            document.getElementById('pappaValue').textContent = pappa.toFixed(2);
            document.getElementById('pappaMedian').textContent = pappaMedian.toFixed(2);
            document.getElementById('pappaMom').textContent = pappaMom.toFixed(2);
            
            document.getElementById('ntValue').textContent = nt.toFixed(1);
            document.getElementById('ntMom').textContent = ntMom.toFixed(2);
            
            // Create risk visualization chart
            createRiskChart(riskT21, riskT18, riskT13);
            
            // Set interpretation and recommendations
            setInterpretationAndRecommendations(riskT21, riskT18, riskT13, nt, nasalBone, tricuspidFlow);
        }
        
        function formatRisk(risk) {
            if (risk >= 1) return "1:1";
            if (risk <= 0) return "1:∞";
            
            const inverse = Math.round(1 / risk);
            return `1:${inverse}`;
        }
        
        function setRiskCategory(elementId, risk) {
            const inverseRisk = 1 / risk;
            const element = document.getElementById(elementId);
            const categoryElement = document.getElementById(`${elementId}Category`);
            
            if (inverseRisk <= 50) {
                // High risk
                element.className = "p-4 rounded-md risk-high";
                categoryElement.textContent = "High Risk";
                categoryElement.className = "text-sm text-red-600 font-medium";
            } else if (inverseRisk <= 1000) {
                // Moderate risk
                element.className = "p-4 rounded-md risk-moderate";
                categoryElement.textContent = "Moderate Risk";
                categoryElement.className = "text-sm text-yellow-600 font-medium";
            } else {
                // Low risk
                element.className = "p-4 rounded-md risk-low";
                categoryElement.textContent = "Low Risk";
                categoryElement.className = "text-sm text-green-600 font-medium";
            }
        }
        
        function createRiskChart(riskT21, riskT18, riskT13) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (window.riskChartInstance) {
                window.riskChartInstance.destroy();
            }
            
            // Calculate inverse risks for visualization
            const invT21 = 1 / riskT21;
            const invT18 = 1 / riskT18;
            const invT13 = 1 / riskT13;
            
            window.riskChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Trisomy 21', 'Trisomy 18', 'Trisomy 13'],
                    datasets: [{
                        label: 'Risk Ratio (1:)',
                        data: [invT21, invT18, invT13],
                        backgroundColor: [
                            invT21 <= 50 ? 'rgba(239, 68, 68, 0.7)' : 
                                invT21 <= 1000 ? 'rgba(234, 179, 8, 0.7)' : 'rgba(34, 197, 94, 0.7)',
                            invT18 <= 50 ? 'rgba(239, 68, 68, 0.7)' : 
                                invT18 <= 1000 ? 'rgba(234, 179, 8, 0.7)' : 'rgba(34, 197, 94, 0.7)',
                            invT13 <= 50 ? 'rgba(239, 68, 68, 0.7)' : 
                                invT13 <= 1000 ? 'rgba(234, 179, 8, 0.7)' : 'rgba(34, 197, 94, 0.7)'
                        ],
                        borderColor: [
                            invT21 <= 50 ? 'rgba(239, 68, 68, 1)' : 
                                invT21 <= 1000 ? 'rgba(234, 179, 8, 1)' : 'rgba(34, 197, 94, 1)',
                            invT18 <= 50 ? 'rgba(239, 68, 68, 1)' : 
                                invT18 <= 1000 ? 'rgba(234, 179, 8, 1)' : 'rgba(34, 197, 94, 1)',
                            invT13 <= 50 ? 'rgba(239, 68, 68, 1)' : 
                                invT13 <= 1000 ? 'rgba(234, 179, 8, 1)' : 'rgba(34, 197, 94, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Risk Ratio (1:value)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `1:${Math.round(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function setInterpretationAndRecommendations(riskT21, riskT18, riskT13, nt, nasalBone, tricuspidFlow) {
            const interpretationText = document.getElementById('interpretationText');
            const recommendationsList = document.getElementById('recommendationsList');
            
            // Clear previous recommendations
            recommendationsList.innerHTML = '';
            
            // Base interpretation
            let interpretation = "The risk assessment is based on maternal age, fetal nuchal translucency measurement, and maternal serum biochemistry (free β-hCG and PAPP-A). ";
            
            // Add specific findings
            if (nt > 3.5) {
                interpretation += "The nuchal translucency measurement is significantly increased, which may indicate an increased risk for chromosomal abnormalities or congenital heart defects. ";
            } else if (nt > 2.5) {
                interpretation += "The nuchal translucency measurement is mildly increased. ";
            }
            
            if (nasalBone === 'absent') {
                interpretation += "The fetal nasal bone appears absent, which is a soft marker for trisomy 21. ";
            }
            
            if (tricuspidFlow === 'regurgitation') {
                interpretation += "Tricuspid regurgitation was observed, which may indicate cardiac abnormalities. ";
            }
            
            interpretation += "This screening test has a detection rate of approximately 90% for trisomy 21 with a 5% false-positive rate.";
            
            interpretationText.textContent = interpretation;
            
            // Add standard recommendations
            addRecommendation(recommendationsList, "Detailed counseling regarding the screening results should be provided.");
            
            // Risk-specific recommendations
            const inverseRiskT21 = 1 / riskT21;
            
            if (inverseRiskT21 <= 50) {
                addRecommendation(recommendationsList, "Invasive diagnostic testing (CVS or amniocentesis) should be offered due to high risk for trisomy 21.");
                addRecommendation(recommendationsList, "Consider fetal echocardiography due to increased NT measurement.");
            } else if (inverseRiskT21 <= 1000) {
                addRecommendation(recommendationsList, "Non-invasive prenatal testing (NIPT) should be considered as a follow-up test.");
                addRecommendation(recommendationsList, "Detailed ultrasound at 18-20 weeks is recommended.");
            } else {
                addRecommendation(recommendationsList, "Routine prenatal care is recommended with standard ultrasound at 18-20 weeks.");
            }
            
            if (nt > 3.5) {
                addRecommendation(recommendationsList, "Fetal echocardiography is strongly recommended due to significantly increased NT measurement.");
            } else if (nt > 2.5) {
                addRecommendation(recommendationsList, "Consider fetal echocardiography due to mildly increased NT measurement.");
            }
            
            if (nasalBone === 'absent') {
                addRecommendation(recommendationsList, "Follow-up ultrasound to reassess nasal bone is recommended.");
            }
            
            if (tricuspidFlow === 'regurgitation') {
                addRecommendation(recommendationsList, "Fetal echocardiography is recommended due to tricuspid regurgitation.");
            }
        }
        
        function addRecommendation(listElement, text) {
            const li = document.createElement('li');
            li.textContent = text;
            li.className = "mb-1";
            listElement.appendChild(li);
        }
        
        // Print and PDF functions
        function printReport() {
            // Hide everything except results before printing
            document.body.classList.add('printing');
            window.print();
            document.body.classList.remove('printing');
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            // Use html2canvas to capture the results section
            html2canvas(document.getElementById('resultsSection'), {
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = doc.internal.pageSize.getWidth() - 40;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                doc.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
                
                // Add disclaimer
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text('Disclaimer: This screening test provides a risk assessment and is not diagnostic. Consult a genetic counselor or specialist for further information.', 
                    40, doc.internal.pageSize.getHeight() - 30, {maxWidth: 500});
                
                // Add footer
                doc.text('Developed by Clinicalsci | Medical Screening Solutions', 
                    doc.internal.pageSize.getWidth()/2, doc.internal.pageSize.getHeight() - 10, 
                    {align: 'center'});
                
                // Save the PDF
                doc.save('First_Trimester_Screening_Report.pdf');
            });
        }
        
        function resetForm() {
            // Clear all form fields
            document.getElementById('patientName').value = '';
            document.getElementById('patientId').value = '';
            document.getElementById('dob').value = '';
            document.getElementById('ethnicity').selectedIndex = 0;
            document.getElementById('lmp').value = '';
            document.getElementById('crl').value = '';
            document.getElementById('weeks').value = '';
            document.getElementById('days').value = '';
            document.getElementById('betaHcg').value = '';
            document.getElementById('pappa').value = '';
            document.getElementById('nt').value = '';
            document.getElementById('nasalBone').selectedIndex = 0;
            document.getElementById('tricuspidFlow').selectedIndex = 0;
            document.getElementById('maternalAge').value = '';
            document.getElementById('previousTrisomy').selectedIndex = 0;
            document.getElementById('calculatedGA').textContent = 'Enter CRL to calculate';
            document.getElementById('forceGA').checked = false;
            
            // Destroy chart if exists
            if (window.riskChartInstance) {
                window.riskChartInstance.destroy();
                window.riskChartInstance = null;
            }
            
            // Hide results section
            resultsSection.classList.add('hidden');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
